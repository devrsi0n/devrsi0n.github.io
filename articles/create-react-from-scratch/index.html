<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.20.2"/><title data-react-helmet="true">⚛️ Re: 从零开始的 React 再造之旅</title><meta data-react-helmet="true" charSet="utf-8"/><meta data-react-helmet="true" http-equiv="X-UA-Compatible" content="IE=edge"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" name="theme-color" content="#fff"/><meta data-react-helmet="true" itemProp="name" content="⚛️ Re: 从零开始的 React 再造之旅"/><meta data-react-helmet="true" itemProp="description" content="不依赖任何第三方包，从零开始动手造 React"/><meta data-react-helmet="true" itemProp="image" content="https://devrsi0n.comhttps://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/763c0/hero.jpg"/><meta data-react-helmet="true" name="description" content="不依赖任何第三方包，从零开始动手造 React"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:site" content="@devrsi0n"/><meta data-react-helmet="true" name="twitter:title" content="⚛️ Re: 从零开始的 React 再造之旅"/><meta data-react-helmet="true" name="twitter:description" content="不依赖任何第三方包，从零开始动手造 React"/><meta data-react-helmet="true" name="twitter:creator" content="@devrsi0n"/><meta data-react-helmet="true" name="twitter:image" content="https://devrsi0n.comhttps://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/763c0/hero.jpg"/><meta data-react-helmet="true" property="og:title" content="⚛️ Re: 从零开始的 React 再造之旅"/><meta data-react-helmet="true" property="og:url"/><meta data-react-helmet="true" property="og:image" content="https://devrsi0n.comhttps://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/763c0/hero.jpg"/><meta data-react-helmet="true" property="og:description" content="不依赖任何第三方包，从零开始动手造 React"/><meta data-react-helmet="true" property="og:site_name" content="devrsi0n"/><meta data-react-helmet="true" name="article:published_time" content="2020-02-04"/><meta data-react-helmet="true" name="twitter:label1" content="Reading time"/><meta data-react-helmet="true" name="twitter:data1" content="3 min read"/><script data-react-helmet="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://devrsi0n.com/articles/create-react-from-scratch"},"headline":"⚛️ Re: 从零开始的 React 再造之旅","image":"https://devrsi0n.comhttps://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/763c0/hero.jpg","datePublished":"2020-02-04T00:00:00.000Z","dateModified":"2020-02-04T00:00:00.000Z","author":[{"@type":"Person","name":"Devrsi0n"}],"description":"不依赖任何第三方包，从零开始动手造 React","publisher":{"@type":"Organization","name":"devrsi0n","logo":{"@type":"ImageObject","url":"https://devrsi0n.com/icons/icon-512x512.png"}}}</script><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="icon" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-48x48.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#fff"/><link rel="apple-touch-icon" sizes="48x48" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-48x48.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="apple-touch-icon" sizes="72x72" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-72x72.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="apple-touch-icon" sizes="96x96" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-96x96.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="apple-touch-icon" sizes="144x144" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-144x144.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="apple-touch-icon" sizes="192x192" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-192x192.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="apple-touch-icon" sizes="256x256" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-256x256.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="apple-touch-icon" sizes="384x384" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-384x384.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="apple-touch-icon" sizes="512x512" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/icons/icon-512x512.png?v=9529d2ed4cf55e259b7d221e54672b21"/><link rel="alternate" type="application/rss+xml" title="Devrsi0n&#x27;s blog feed" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/rss.xml"/><link as="script" rel="preload" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/webpack-runtime-e575948f7a0458f785af.js"/><link as="script" rel="preload" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/app-9a96210c0e3b8bf502b6.js"/><link as="script" rel="preload" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/commons-d79b95189de3e8e608cb.js"/><link as="script" rel="preload" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/component---src-templates-article-template-tsx-15dc0f82dde1b20bc2e4.js"/><link as="fetch" rel="preload" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/page-data/articles/create-react-from-scratch/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="15nhvig">body{--theme-ui-colors-text:var(--theme-ui-colors-text,#08080B);--theme-ui-colors-background:var(--theme-ui-colors-background,#fefefe);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#000);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#73737D);--theme-ui-colors-muted:var(--theme-ui-colors-muted,hsl(10,20%,94%));--theme-ui-colors-accent:var(--theme-ui-colors-accent,#6166DC);--theme-ui-colors-highlight:var(--theme-ui-colors-highlight,#dedff8);--theme-ui-colors-purple:var(--theme-ui-colors-purple,hsl(250,60%,30%));--theme-ui-colors-gray:var(--theme-ui-colors-gray,#999);--theme-ui-colors-useColorSchemeMediaQuery:var(--theme-ui-colors-useColorSchemeMediaQuery,true);--theme-ui-colors-prism-token:var(--theme-ui-colors-prism-token,#24292eff);--theme-ui-colors-prism-languageJavascript:var(--theme-ui-colors-prism-languageJavascript,#e8696b);--theme-ui-colors-prism-javascript:var(--theme-ui-colors-prism-javascript,#e8696b);--theme-ui-colors-prism-background:var(--theme-ui-colors-prism-background,#f0f5f5);--theme-ui-colors-prism-comment:var(--theme-ui-colors-prism-comment,#6a737d);--theme-ui-colors-prism-string:var(--theme-ui-colors-prism-string,#032f62);--theme-ui-colors-prism-var:var(--theme-ui-colors-prism-var,#005cc5);--theme-ui-colors-prism-number:var(--theme-ui-colors-prism-number,#22863a);--theme-ui-colors-prism-constant:var(--theme-ui-colors-prism-constant,#005cc5);--theme-ui-colors-prism-plain:var(--theme-ui-colors-prism-plain,#032f62);--theme-ui-colors-prism-doctype:var(--theme-ui-colors-prism-doctype,#e8696b);--theme-ui-colors-prism-tag:var(--theme-ui-colors-prism-tag,#22863a);--theme-ui-colors-prism-keyword:var(--theme-ui-colors-prism-keyword,#6f42c1);--theme-ui-colors-prism-boolean:var(--theme-ui-colors-prism-boolean,#ff5874);--theme-ui-colors-prism-function:var(--theme-ui-colors-prism-function,#6f42c1);--theme-ui-colors-prism-parameter:var(--theme-ui-colors-prism-parameter,#E27F2D);--theme-ui-colors-prism-className:var(--theme-ui-colors-prism-className,#6f42c1);--theme-ui-colors-prism-attrName:var(--theme-ui-colors-prism-attrName,#6f42c1);--theme-ui-colors-prism-attrValue:var(--theme-ui-colors-prism-attrValue,#a8e2a8);--theme-ui-colors-prism-interpolation:var(--theme-ui-colors-prism-interpolation,#032f62);--theme-ui-colors-prism-punctuation:var(--theme-ui-colors-prism-punctuation,#d73a49);--theme-ui-colors-prism-maybe-class-name:var(--theme-ui-colors-prism-maybe-class-name,#000);--theme-ui-colors-prism-property:var(--theme-ui-colors-prism-property,#005cc5);--theme-ui-colors-prism-propertyAccess:var(--theme-ui-colors-prism-propertyAccess,#005cc5);--theme-ui-colors-prism-namespace:var(--theme-ui-colors-prism-namespace,#b2ccd6);--theme-ui-colors-prism-highlight:var(--theme-ui-colors-prism-highlight,fffbdd);--theme-ui-colors-prism-highlightBorder:var(--theme-ui-colors-prism-highlightBorder,#e1bde2);--theme-ui-colors-prism-dom:var(--theme-ui-colors-prism-dom,#5F8DC3);--theme-ui-colors-prism-operator:var(--theme-ui-colors-prism-operator,#24292eff);--theme-ui-colors-prism-lineNumber:var(--theme-ui-colors-prism-lineNumber,#333);--theme-ui-colors-codeLabel:var(--theme-ui-colors-codeLabel,#08080B);--theme-ui-colors-grey:var(--theme-ui-colors-grey,#73737D);--theme-ui-colors-hover:var(--theme-ui-colors-hover,rgba(0,0,0,0.07));--theme-ui-colors-gradient:var(--theme-ui-colors-gradient,linear-gradient(180deg,rgba(217,219,224,0) 0%,#D9DBE0 100%));--theme-ui-colors-track:var(--theme-ui-colors-track,rgba(8,8,11,0.3));--theme-ui-colors-progress-complete:var(--theme-ui-colors-progress-complete,#000);--theme-ui-colors-progress-bg:var(--theme-ui-colors-progress-bg,#B5B8B9);--theme-ui-colors-card:var(--theme-ui-colors-card,#fff);--theme-ui-colors-error:var(--theme-ui-colors-error,#EE565B);--theme-ui-colors-success:var(--theme-ui-colors-success,#46B17B);--theme-ui-colors-errorBackground:var(--theme-ui-colors-errorBackground,rgba(238,86,91,0.1));--theme-ui-colors-horizontalRule:var(--theme-ui-colors-horizontalRule,rgba(8,8,11,0.15));--theme-ui-colors-inputBackground:var(--theme-ui-colors-inputBackground,rgba(0,0,0,0.05));color:var(--theme-ui-colors-text,#08080B);background-color:var(--theme-ui-colors-background,#fefefe);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#fff);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#fff);--theme-ui-colors-accent:var(--theme-ui-colors-modes-dark-accent,#E9DAAC);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,rgba(17,18,22,0.95));--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,hsl(10,20%,94%));--theme-ui-colors-highlight:var(--theme-ui-colors-modes-dark-highlight,#f4ecd4);--theme-ui-colors-purple:var(--theme-ui-colors-modes-dark-purple,hsl(250,60%,30%));--theme-ui-colors-gray:var(--theme-ui-colors-modes-dark-gray,#666);--theme-ui-colors-prism-token:var(--theme-ui-colors-modes-dark-prism-token,#fff);--theme-ui-colors-prism-languageJavascript:var(--theme-ui-colors-modes-dark-prism-languageJavascript,#e8696b);--theme-ui-colors-prism-javascript:var(--theme-ui-colors-modes-dark-prism-javascript,#e8696b);--theme-ui-colors-prism-background:var(--theme-ui-colors-modes-dark-prism-background,#292c34);--theme-ui-colors-prism-comment:var(--theme-ui-colors-modes-dark-prism-comment,#5e6a76);--theme-ui-colors-prism-string:var(--theme-ui-colors-modes-dark-prism-string,#a8e2a8);--theme-ui-colors-prism-var:var(--theme-ui-colors-modes-dark-prism-var,#b3bac5);--theme-ui-colors-prism-number:var(--theme-ui-colors-modes-dark-prism-number,#e4854d);--theme-ui-colors-prism-constant:var(--theme-ui-colors-modes-dark-prism-constant,#b3bac5);--theme-ui-colors-prism-plain:var(--theme-ui-colors-modes-dark-prism-plain,#fff);--theme-ui-colors-prism-doctype:var(--theme-ui-colors-modes-dark-prism-doctype,#e8696b);--theme-ui-colors-prism-tag:var(--theme-ui-colors-modes-dark-prism-tag,#e8696b);--theme-ui-colors-prism-keyword:var(--theme-ui-colors-modes-dark-prism-keyword,#d49fd4);--theme-ui-colors-prism-boolean:var(--theme-ui-colors-modes-dark-prism-boolean,#ff5874);--theme-ui-colors-prism-function:var(--theme-ui-colors-modes-dark-prism-function,#5F8DC3);--theme-ui-colors-prism-parameter:var(--theme-ui-colors-modes-dark-prism-parameter,#F9965D);--theme-ui-colors-prism-className:var(--theme-ui-colors-modes-dark-prism-className,#ffcf74);--theme-ui-colors-prism-attrName:var(--theme-ui-colors-modes-dark-prism-attrName,#bf87ba);--theme-ui-colors-prism-attrValue:var(--theme-ui-colors-modes-dark-prism-attrValue,#a8e2a8);--theme-ui-colors-prism-interpolation:var(--theme-ui-colors-modes-dark-prism-interpolation,#fff);--theme-ui-colors-prism-punctuation:var(--theme-ui-colors-modes-dark-prism-punctuation,#5FA8AA);--theme-ui-colors-prism-maybe-class-name:var(--theme-ui-colors-modes-dark-prism-maybe-class-name,#fff);--theme-ui-colors-prism-property:var(--theme-ui-colors-modes-dark-prism-property,#80cbc4);--theme-ui-colors-prism-propertyAccess:var(--theme-ui-colors-modes-dark-prism-propertyAccess,#fff);--theme-ui-colors-prism-namespace:var(--theme-ui-colors-modes-dark-prism-namespace,#b2ccd6);--theme-ui-colors-prism-highlight:var(--theme-ui-colors-modes-dark-prism-highlight,rgba(255,255,255,0.07));--theme-ui-colors-prism-highlightBorder:var(--theme-ui-colors-modes-dark-prism-highlightBorder,#e1bde2);--theme-ui-colors-prism-dom:var(--theme-ui-colors-modes-dark-prism-dom,#5F8DC3);--theme-ui-colors-prism-operator:var(--theme-ui-colors-modes-dark-prism-operator,#5FA8AA);--theme-ui-colors-prism-lineNumber:var(--theme-ui-colors-modes-dark-prism-lineNumber,#dcd9e6);--theme-ui-colors-codeLabel:var(--theme-ui-colors-modes-dark-codeLabel,#292c34);--theme-ui-colors-grey:var(--theme-ui-colors-modes-dark-grey,#73737D);--theme-ui-colors-hover:var(--theme-ui-colors-modes-dark-hover,rgba(255,255,255,0.07));--theme-ui-colors-gradient:var(--theme-ui-colors-modes-dark-gradient,linear-gradient(180deg,#111216 0%,rgba(66,81,98,0.36) 100%));--theme-ui-colors-track:var(--theme-ui-colors-modes-dark-track,rgba(255,255,255,0.3));--theme-ui-colors-progress-complete:var(--theme-ui-colors-modes-dark-progress-complete,#fff);--theme-ui-colors-progress-bg:var(--theme-ui-colors-modes-dark-progress-bg,#73737D);--theme-ui-colors-card:var(--theme-ui-colors-modes-dark-card,#1D2128);--theme-ui-colors-error:var(--theme-ui-colors-modes-dark-error,#EE565B);--theme-ui-colors-success:var(--theme-ui-colors-modes-dark-success,#46B17B);--theme-ui-colors-errorBackground:var(--theme-ui-colors-modes-dark-errorBackground,rgba(238,86,91,0.1));--theme-ui-colors-horizontalRule:var(--theme-ui-colors-modes-dark-horizontalRule,rgba(255,255,255,0.15));--theme-ui-colors-inputBackground:var(--theme-ui-colors-modes-dark-inputBackground,rgba(255,255,255,0.07));}</style><style data-emotion-css="0"></style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="2fbk2o">.css-2fbk2o{position:relative;background:var(--theme-ui-colors-background,#fefefe);-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);min-height:100vh;}</style><div class="css-2fbk2o efi0dji0"><style data-emotion-css="1mtjyt9">:root{--ease-in-quad:cubic-bezier(0.55,0.085,0.68,0.53);--ease-in-quart:cubic-bezier(0.895,0.03,0.685,0.22);--ease-out-quad:cubic-bezier(0.25,0.46,0.45,0.94);--ease-out-quart:cubic-bezier(0.165,0.84,0.44,1);--ease-in-out-quad:cubic-bezier(0.455,0.03,0.515,0.955);--ease-in-out-quart:cubic-bezier(0.77,0,0.175,1);}::selection{background:var(--theme-ui-colors-accent,#6166DC);color:var(--theme-ui-colors-background,#fefefe);}*,*:before,*:after{box-sizing:inherit;margin:0;padding:0;font-size:inherit;font-display:block;}:root{-ms-overflow-style:-ms-autohiding-scrollbar;box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility;cursor:default;font-size:0.625rem;line-height:1.4;}body{font-family:"SF Pro Display","-apple-system","BlinkMacSystemFont","San Francisco","Helvetica Neue","Helvetica","Ubuntu","Roboto","Noto","Segoe UI","Arial","PingFang SC" ,"Hiragino Sans GB" ,"Microsoft YaHei" ,"Heiti SC" ,"WenQuanYi Micro Hei",sans-serif;font-size:1.6rem;margin:0;font-weight:400;height:100%;-webkit-scroll-behavior:smooth;-moz-scroll-behavior:smooth;-ms-scroll-behavior:smooth;scroll-behavior:smooth;}article{word-break:break-word;}button,a{-webkit-text-decoration:none;text-decoration:none;cursor:pointer;}a:focus{outline:none;}audio,canvas,iframe,img,svg,video{vertical-align:middle;-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;}input,textarea,select,button{font-family:"SF Pro Display","-apple-system","BlinkMacSystemFont","San Francisco","Helvetica Neue","Helvetica","Ubuntu","Roboto","Noto","Segoe UI","Arial","PingFang SC" ,"Hiragino Sans GB" ,"Microsoft YaHei" ,"Heiti SC" ,"WenQuanYi Micro Hei",sans-serif;}.underline{-webkit-text-decoration:underline;text-decoration:underline;}button,input,select,textarea{color:inherit;font-style:inherit;font-weight:inherit;}code,kbd,pre,samp{font-family:"Dank Mono","Noto Sans Mono","Menlo","Roboto Mono","Consolas","Operator Mono","Monaco","source-code-pro","Courier New","SF Pro Display","-apple-system","BlinkMacSystemFont","San Francisco","Helvetica Neue","Helvetica","Ubuntu","Roboto","Noto","Segoe UI","Arial","PingFang SC" ,"Hiragino Sans GB" ,"Microsoft YaHei" ,"Heiti SC" ,"WenQuanYi Micro Hei",sans-serif,monospace;}fieldset,button{-webkit-appearance:none;-moz-appearance:none;appearance:none;border:none;outline:none;background:transparent;}table{border-collapse:separate;border-spacing:0;}audio:not([controls]){display:none;}details{display:block;}input:focus,input:active{outline:none;}input[type='number']{width:auto;}img.Image__Zoom ~ div{background:transparent !important;}</style><style data-emotion-css="il8sto">.css-il8sto{width:100%;max-width:1220px;margin:0 auto;padding:0 4rem;}@media (max-width:66.875em){.css-il8sto{max-width:850px;}}@media (max-width:45.9375em){.css-il8sto{padding:0 4rem;max-width:567px;}}@media (max-width:33.75em){.css-il8sto{max-width:100%;}}</style><section class="css-il8sto evd0b9i0"><style data-emotion-css="ysq45m">.css-ysq45m{position:relative;z-index:100;padding-top:100px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}@media (max-width:80em){.css-ysq45m{padding-top:50px;}}@media screen and (max-height:800px){.css-ysq45m{padding-top:50px;}}</style><div class="css-ysq45m e1qzb8ph1"><style data-emotion-css="1l8rjly">.css-1l8rjly{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;left:0;}@media (max-width:80em){.css-1l8rjly{left:0;}}.css-1l8rjly[data-a11y="true"]:focus::after{content:'';position:absolute;left:-10%;top:-30%;width:120%;height:160%;border:2px solid var(--theme-ui-colors-accent,#6166DC);background:rgba(255,255,255,0.01);border-radius:5px;}.css-1l8rjly:hover .e1qzb8ph0{-webkit-transform:translateX(-3px);-ms-transform:translateX(-3px);transform:translateX(-3px);}</style><a data-a11y="false" title="回到主页" aria-label="回到主页" back="false" class="css-1l8rjly e1qzb8ph2" href="/"><style data-emotion-css="ru2oqr">.css-ru2oqr .Logo__Mobile{display:none;}@media (max-width:45.9375em){.css-ru2oqr .Logo__Desktop{display:none;}.css-ru2oqr .Logo__Mobile{display:block;}}</style><div class="css-ru2oqr ej2idmd0"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAQAAADa613fAAAAAmJLR0QA/4ePzL8AAAPcSURBVHja7ZrLTxNRFMa/QkAjj8hK8RV5aBeyUHChxIXIRiLRgg2QaFzJ1ijqHyAmBlkIUfoXIBF5rDSuQFgYdOkCpKArHiZGfBRqBAPWze3pdDqde6ct0xlzvlnNzHfOnd/MPXOntxdgsVgsFovFYjlHF7CERTS4Nj9pERFEsODa/JYb8qAG9zGJIMIII4gJdKLaSSANWMQCzksgWjCHiMEWhB+etPNbUhV6MYMwXYJ6f67AO0OI6PYW5RbqIhoVxjR6UWUNIh8BbOmaV+0GZ/DFFCOCCFZwTrk7xUduIoB8dYxxg8bVQOrwhyI2MIg2eFGAAnjRhkFsaM6dTQkkggjGVVEChndRpT9XYIX8wyhL8JdjhM5/1Zw3qwuja+lTq41NYZ+FD0UWOqSHamMTt5O67lCnnZKUfbyK4EOQ8h+TB/QSxm6Lr4dWumMdpr675LtssYUSQumRm2eE1WexEQ+9cIel3lG6WR6LrTSJyGm5dVVYiyw2cZLKuELqLcO6cJ+w2EqxiFuVW82K20ydIu6ZkntIuO9Zbkf5+lIFmRBxbUruK8L92n4Q/eir3/8o4iqVLsdLnyyq+TMGoh+09PtrIq5QCaRQuNeU89sG8lvE7VQC2SXcv+wH0Y+++v3PIu6wEki5cC8p57et2CdFnF/J3Zq9YpepW8QNKLkHhbvLeSC1NCDKO9ch+g4+5TwQD+ZF5IjUO0ovX4/zQIBrFHvT1HeLfFdTaMUGkFxMidgtE5QO+ox/g1yngOhH36MIUfxLTa0Y/Tj6ofkGsDKXtS0giYNWvebnbNgEZAN1pnmyDgLU42dCjsSnUSfNYyuI8eh7RApSqZRnm0FU+nOyHCoXIcufMRCVbpAOiCw/g6jVReZAZPltGBBjiv7I2hN3dJ84Gkort60g0Ym6F9hLx0rxiibmXANyw3QKu909IDvwPinGWApfvFkDAfYbzuhHMIbSNDPbDAJ40I5vun9Frqf5NLICAgBefNdgHMhIzqyAAAcxhBBCeJ4hjKyBZF4MwiAMwiAMwiAMwiAMwiAM8v+CpLqoxh5ZWFST6jIne9Ssvsyph/6oLHEcRgmtCXskN8eWAs6hCcUO6lTNhJF0KWAjlqVLXJ26LaMxBrLkWoz49Sw0e+7OTTO7P+dqkNjiNQyIQ48dOwwaqU9cdX/sUIs4tI7jrsGopn/0NQur8vGJCscdKDX0np1HnvZEk2ZNwhOcdugHCgAUohYBehp/cVFv6HZloT9IJM3BQ9dhdCHH+LH5aPWu87d5XDLrgXnw4ylmHTxEruED+uGPL3EWi8VisVgsFovFyp7+AUf7AN5D8o1TAAAAAElFTkSuQmCC" alt="logo" width="35px"/></div><style data-emotion-css="10l5b14">.css-10l5b14{position:absolute;display:inline-block;opacity:0;width:0px;height:0px;visibility:hidden;overflow:hidden;}</style><span class="css-10l5b14 e1qzb8ph8">回到主页</span></a><style data-emotion-css="1qdrnpx">.css-1qdrnpx{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}@media (max-width:33.75em){.css-1qdrnpx{right:-5px;}}</style><div class="css-1qdrnpx e1qzb8ph3"><style data-emotion-css="5v6dgv">.css-5v6dgv{opacity:0.5;position:relative;border-radius:5px;width:40px;height:25px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-transition:opacity 0.3s ease;transition:opacity 0.3s ease;margin-left:30px;}.css-5v6dgv:hover{opacity:1;}.css-5v6dgv[data-a11y='true']:focus::after{content:'';position:absolute;left:0;top:-30%;width:100%;height:160%;border:2px solid var(--theme-ui-colors-accent,#6166DC);background:rgba(255,255,255,0.01);border-radius:5px;}@media (max-width:45.9375em){.css-5v6dgv{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-transform:scale(0.708);-ms-transform:scale(0.708);transform:scale(0.708);margin-left:10px;}.css-5v6dgv:hover{opacity:0.5;}}</style><button data-a11y="false" aria-label="复制 URL 到剪切板" title="复制 URL 到剪切板" class="css-5v6dgv e1qzb8ph5"><svg width="24" height="20" viewBox="0 0 24 20" fill="#000" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 5C2 3.34328 3.34328 2 5 2H14C15.6567 2 17 3.34328 17 5V9C17 10.6567 15.6567 12 14 12H10C9.44771 12 9 12.4477 9 13C9 13.5523 9.44771 14 10 14H14C16.7613 14 19 11.7613 19 9V5C19 2.23872 16.7613 0 14 0H5C2.23872 0 0 2.23872 0 5V9C0 10.4938 0.656313 11.8361 1.6935 12.7509C2.10768 13.1163 2.73961 13.0767 3.10494 12.6625C3.47028 12.2483 3.43068 11.6164 3.0165 11.2511C2.39169 10.6999 2 9.89621 2 9V5ZM7 11C7 9.34328 8.34328 8 10 8H14C14.5523 8 15 7.55228 15 7C15 6.44772 14.5523 6 14 6H10C7.23872 6 5 8.23872 5 11V15C5 17.7613 7.23872 20 10 20H19C21.7613 20 24 17.7613 24 15V11C24 9.50621 23.3437 8.16393 22.3065 7.24906C21.8923 6.88372 21.2604 6.92332 20.8951 7.3375C20.5297 7.75168 20.5693 8.38361 20.9835 8.74894C21.6083 9.30007 22 10.1038 22 11V15C22 16.6567 20.6567 18 19 18H10C8.34328 18 7 16.6567 7 15V11Z" fill="#000"></path></svg><style data-emotion-css="1fk2nj2">.css-1fk2nj2{position:absolute;padding:4px 13px;background:rgba(0,0,0,0.1);color:#000;border-radius:5px;font-size:14px;top:-35px;opacity:0;-webkit-transform:none;-ms-transform:none;transform:none;-webkit-transition:-webkit-transform 0.3s ease-in-out,opacity 0.3s ease-in-out;-webkit-transition:transform 0.3s ease-in-out,opacity 0.3s ease-in-out;transition:transform 0.3s ease-in-out,opacity 0.3s ease-in-out;white-space:nowrap;}.css-1fk2nj2::after{content:'';position:absolute;left:0;right:0;bottom:-6px;margin:0 auto;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid rgba(0,0,0,0.1);}</style><span class="css-1fk2nj2 e1qzb8ph4">复制成功</span></button><button data-a11y="false" aria-label="打开黑夜模式" title="打开黑夜模式" class="css-5v6dgv e1qzb8ph5"><style data-emotion-css="5bwd48">.css-5bwd48{position:relative;width:24px;height:24px;border-radius:50%;border:2px solid var(--theme-ui-colors-primary,#000);background:var(--theme-ui-colors-primary,#000);-webkit-transform:scale(1);-ms-transform:scale(1);transform:scale(1);-webkit-transition:all 0.45s ease;transition:all 0.45s ease;overflow:hidden;}.css-5bwd48::before{content:'';position:absolute;right:-9px;top:-9px;height:24px;width:24px;border:2px solid var(--theme-ui-colors-primary,#000);border-radius:50%;-webkit-transform:translate(0,0);-ms-transform:translate(0,0);transform:translate(0,0);opacity:1;-webkit-transition:-webkit-transform 0.45s ease;-webkit-transition:transform 0.45s ease;transition:transform 0.45s ease;}.css-5bwd48::after{content:'';width:8px;height:8px;border-radius:50%;margin:-4px 0 0 -4px;position:absolute;top:50%;left:50%;box-shadow:0 -23px 0 var(--theme-ui-colors-primary,#000),0 23px 0 var(--theme-ui-colors-primary,#000),23px 0 0 var(--theme-ui-colors-primary,#000),-23px 0 0 var(--theme-ui-colors-primary,#000),15px 15px 0 var(--theme-ui-colors-primary,#000),-15px 15px 0 var(--theme-ui-colors-primary,#000),15px -15px 0 var(--theme-ui-colors-primary,#000),-15px -15px 0 var(--theme-ui-colors-primary,#000);-webkit-transform:scale(0);-ms-transform:scale(0);transform:scale(0);-webkit-transition:all 0.35s ease;transition:all 0.35s ease;}@media (max-width:45.9375em){.css-5bwd48::after{-webkit-transform:scale(0);-ms-transform:scale(0);transform:scale(0);}}</style><div class="css-5bwd48 e1qzb8ph6"></div><style data-emotion-css="vnjej0">.css-vnjej0{position:absolute;right:-1px;top:-8px;height:24px;width:24px;border-radius:50%;border:0;background:var(--theme-ui-colors-background,#fefefe);-webkit-transform:translate(0,0);-ms-transform:translate(0,0);transform:translate(0,0);opacity:1;-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad),-webkit-transform 0.45s ease;-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad),transform 0.45s ease;transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad),transform 0.45s ease;}</style><div class="css-vnjej0 e1qzb8ph7"></div></button></div></div></section><main style="opacity:1"><style data-emotion-css="oytfqz">@media (max-width:33.75em){.css-oytfqz::before{content:"";width:100%;height:20px;background:var(--theme-ui-colors-primary,#000);position:absolute;left:0;top:0;-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);}.css-oytfqz::after{content:"";width:100%;height:10px;background:var(--theme-ui-colors-background,#fefefe);position:absolute;left:0;top:10px;border-top-left-radius:25px;border-top-right-radius:25px;-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);}}</style><div class="css-oytfqz e1mhnqxm2"><style data-emotion-css="1ito37z">.css-1ito37z{position:relative;z-index:10;margin:100px auto 120px;padding-left:68px;max-width:749px;}@media (max-width:66.875em){.css-1ito37z{padding-left:53px;max-width:calc(507px + 53px);margin:100px auto 70px;}}@media (max-width:45.9375em){.css-1ito37z{padding-left:0;margin:100px auto 70px;max-width:480px;}}@media (max-width:33.75em){.css-1ito37z{margin:170px auto 180px;padding:0 40px;}}@media screen and (max-height:700px){.css-1ito37z{margin:100px auto;}}</style><header class="css-1ito37z e1mhnqxm4"><style data-emotion-css="1qjsprb">.css-1qjsprb{font-size:52px;line-height:1.15;word-break:keep-all;font-weight:bold;color:var(--theme-ui-colors-primary,#000);font-family:Georgia,"Noto Serif CJK SC","Source Han Serif SC","Source Han Serif CN","Songti SC","SimSun","STSong","AR PL Sungti",serif;font-size:48px;font-family:Georgia,"Noto Serif CJK SC","Source Han Serif SC","Source Han Serif CN","Songti SC","SimSun","STSong","AR PL Sungti",serif;margin-bottom:25px;font-weight:bold;line-height:1.32;text-align:center;}@media (max-width:66.875em){.css-1qjsprb{font-size:38px;line-height:1.2;}}@media (max-width:33.75em){.css-1qjsprb{font-size:32px;line-height:1.3;}}@media (max-width:45.9375em){.css-1qjsprb{margin-bottom:20px;font-size:36px;}}@media (max-width:33.75em){.css-1qjsprb{font-size:32px;text-align:unset;}}</style><h1 class="css-1qjsprb e1mhnqxm5">⚛️ Re: 从零开始的 React 再造之旅</h1><style data-emotion-css="jc1n92">.css-jc1n92{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;font-size:16px;color:var(--theme-ui-colors-grey,#73737D);}@media (max-width:33.75em){.css-jc1n92{font-size:14px;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-jc1n92 strong{display:block;font-weight:500;margin-bottom:5px;}}</style><div class="css-jc1n92 e1mhnqxm6"><style data-emotion-css="1mpu0fb">.css-1mpu0fb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:inherit;}.css-1mpu0fb strong{-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);}.css-1mpu0fb:hover strong{color:var(--theme-ui-colors-primary,#000);}</style><div to="/authors/devrsi0n" class="css-1mpu0fb eqh94592"><style data-emotion-css="u1pf06">.css-u1pf06{height:25px;width:25px;border-radius:50%;margin-right:14px;background:var(--theme-ui-colors-grey,#73737D);overflow:hidden;}.css-u1pf06 .gatsby-image-wrapper > div{padding-bottom:100% !important;}@media (max-width:33.75em){.css-u1pf06{display:none;}}</style><div class="css-u1pf06 eqh94590"><style data-emotion-css="uodor8">.css-uodor8{border-radius:50%;}</style><div class="css-uodor8 eqh94591 gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:100%"></div><img aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20width=&#x27;400&#x27;%20height=&#x27;400&#x27;%3e%3cpath%20d=&#x27;M0%20200v200h401V0H0v200M371%2074l-5%201-5%201-9%203-8%203-2%201c-2%200-17%205-22%208l-4%201-5%201-4%202-2%201-4%201-12%205-2%201-5%202-2%201h-3l-8%205c-7%203-13%207-21%2013l-8%207a116%20116%200%2000-20%2024l-2%205c-2%202-4%207-5%2015l-1%203-2-4c-2-3-3-4-6-4-6-1-10%201-10%206%200%203-3%206-4%204l-1-4-8-21c-6-11-16-20-31-27a40%2040%200%2001-8-5l-12-5-4-1-3-2-4-1-7-2-7-3-11-3a132%20132%200%2000-28-7l-6-2-3-1-2-1-8-2-13-3c-9-2-10%200-4%207%206%205%209%209%2011%2012l10%2011a251%20251%200%200120%2022%202488%202488%200%200130%2032c12%2012%2013%2012%2020%2015l11%202%2010%201%2019%202%2015%202%202%202a1145%201145%200%2001-28%204l-5%201-6%203-9%206-8%206c-4%203-5%203-10%2014l-10%2022-1%202c-1-1-1%200-1%201l-1%204-3%205-1%204-1%202v8c0%207%200%209%205%2014a240%20240%200%200032%2025l8%203c15%203%2019%204%2039%204a836%20836%200%200085-6l6-2%203-1a84%2084%200%200041-23c5-4%209-11%209-15%200-18-9-42-21-54a143%20143%200%2000-27-19c-2-3-19-11-21-11l-2-2h-1c-2%201-6%201-6-1l3-2%204-1%204-1%204-1a317%20317%200%200121-11l4-2%207-6%2010-8a103%20103%200%200021-22l2-3%202-3a285%20285%200%200020-25l20-22c11-10%2013-16%205-11M169%20225h-4l-3%202-1%205c-3%208%205%2014%2013%2010%203-2%204-4%204-10%201-4%201-5-2-6-4-1-6-2-7-1m73%2031c-4%201-6%2014-2%2015%205%202%2015-1%2014-4v-4c0-7-5-9-12-7&#x27;%20fill=&#x27;%23d3d3d3&#x27;%20fill-rule=&#x27;evenodd&#x27;/%3e%3c/svg%3e" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source type='image/webp' srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/22c98/devrsi0n.webp 13w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/34ed2/devrsi0n.webp 25w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/3f6ab/devrsi0n.webp 50w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/4b04b/devrsi0n.webp 75w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/88007/devrsi0n.webp 100w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/76568/devrsi0n.webp 284w" sizes="(max-width: 50px) 100vw, 50px" /><source srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/aeae7/devrsi0n.jpg 13w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/b2812/devrsi0n.jpg 25w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/df39f/devrsi0n.jpg 50w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/8bc12/devrsi0n.jpg 75w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/6d2d1/devrsi0n.jpg 100w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/05da3/devrsi0n.jpg 284w" sizes="(max-width: 50px) 100vw, 50px" /><img loading="lazy" sizes="(max-width: 50px) 100vw, 50px" srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/aeae7/devrsi0n.jpg 13w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/b2812/devrsi0n.jpg 25w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/df39f/devrsi0n.jpg 50w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/8bc12/devrsi0n.jpg 75w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/6d2d1/devrsi0n.jpg 100w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/05da3/devrsi0n.jpg 284w" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a15a786ce398b9fdaee8de7cd303d41c/df39f/devrsi0n.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div><strong>Devrsi0n<!-- --> </strong><style data-emotion-css="sjizha">@media (max-width:33.75em){.css-sjizha{display:none;}}</style><span class="css-sjizha eqh945913">▴ </span></div><style data-emotion-css="1d64qrg">.css-1d64qrg{margin-left:0;}@media (max-width:33.75em){.css-1d64qrg{margin-left:0;}}</style><div class="css-1d64qrg e1mhnqxm3"><span>更新于 </span><time>2020-03-23</time></div></div></header><style data-emotion-css="1mrtj7x">.css-1mrtj7x{position:relative;z-index:1;width:100%;max-width:944px;overflow:hidden;margin:0 auto;box-shadow:0 30px 60px -10px rgba(0,0,0,0.2),0 18px 36px -18px rgba(0,0,0,0.22);}@media (max-width:45.9375em){.css-1mrtj7x{max-width:100%;}}@media (max-width:33.75em){.css-1mrtj7x{margin:0 auto;width:calc(100vw - 40px);height:220px;}.css-1mrtj7x > div{height:220px;}}</style><div id="ArticleImage__Hero" class="css-1mrtj7x e1mhnqxm7"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:75%"></div><img aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20width=&#x27;400&#x27;%20height=&#x27;300&#x27;%3e%3cpath%20d=&#x27;M176%2079c-1%202%203%207%205%207l1%201h-3c-4-1-4%200%201%204l4%203h-3c-3%200-4%203-1%204l1%203-1%202-2%202%201%201v4c2%201%205-1%203-2v-3l8-1c7-1%209-3%204-4-2%200-3-1-4-3-1-5-7-14-10-15-2%200-3-1-3-3-1-2-1-2-1%200m41%202l1%201v10c2%208%203%2010%205%2010l4%2011%204%2011%205%203c5%205%209%205%2018%204%2012-3%2017-7%2016-16-2-18-9-25-22-22l-8%203c-2%200-5%201-7%203-5%203-7%204-7%202l-2-1c-2%200-5-11-3-12s0-7-2-7h-2m55%206c1%202%200%203-1%204-3%200-3%201%203%2022%206%2017%206%2018%204%2019l-2%203c0%203-1%203-18%208a350%20350%200%2000-13%202c-2-2-10%201-10%203l5%205%2017-4%203-2h-4c-6%200-5-1%202-3l8-1-4%203-3%201h4l11-2c6-1%207-2%208-4%200-3%200-5-3-5l-1-1%201-2c4%201%204%200-1-17-8-24-7-23-5-24%202%200%202-8%200-8l-1%203m-158-1l1%208%202%206h-3l-6%201c-3%200-3%200-3%202l2%208c0%205%202%208%202%204%200-2%201%200%202%202a3253%203253%200%20009%200l6-1-1-5-1-10-2-9c0-3-1-4-2-3v-2c-1%201-2%200-3-1%200-1-3-2-3%200m-72%201c-2%200%200%204%203%204h3l-3%201-3%202c0%202-6%207-7%207-2%200-4%207-2%209%202%203%209%201%209-3%200-1%205-2%206-1l1%202c0%201%202%202%203%200h3c2%200%203-1%203-6l-1-5-1%203c0%201-1%202-5%203-8%201-8%201-8-1s3-4%209-6l4-3c0-2%2010-3%2012-1%200%202%2012%200%2022-2%209-3%209-3%209%201%200%202%200%203%202%203l1-2-1-4c0-3-3-2-14%201-9%202-18%203-19%201l-7-1c-4%200-5%200-6-2h-1c-1%202-6%203-6%201s-3-2-6-1m252%206l-7%204-5%204c-5%201-5%209%200%2012a2760%202760%200%20009%2025c5%2017%205%2016-2%2017l-7%202c-1%201-2%200-2-1-1-2-4-3-4-1l1%201c2%200%201%202-2%202-3%201-3%201-2%204%200%203%200%203-2%203-3%200-5%203-4%207%200%202%200%202%201-1%200-3%201-4%205-4l12-2%209-3%204-3%203-3-4-14c-9-31-9-31-12-32s-3-3%201-4l5-3%206-4c5%200%206-2%204-5-1-2-1-2-7-1m38%207l-17%204c-15%203-16%205-12%2017l15%2044c12%2037%2013%2041%2017%2043%202%201%2010-1%2018-3l7-2%207-1%208-2c9-3%2010-4%205-17-8-25-29-81-31-83s-6-2-17%200m6%202l1%206c0%203%200%203-2%202-1%200-3%200-4%202l-3%202c-1-1-5%200-9%201-7%201-8%202-7%203l-4%203c-5%201-5%202%206%2033%2012%2037%2012%2037%2014%2038l1%204%203%202c3-1%207%202%207%204-1%202%206%200%208-2%201-2%203-1%203%201%201%202%201%202%204%201l5-1c1%201%202-1%200-2l1-3c2-2%203-2%204%201h4c3-1%204-1%204-3-1-3%200-7%202-7l1-2-4-10-1-5-3-4-1-3c1-1%200-3-1-5l-2-5-2-8-5-13-2-7-4%202-3%203c0%202-6%202-8%200l-3-1c-2%200-6-11-4-12%202-2%207-2%208%201%200%203-1%204-1%201-2-3-5-1-4%202%201%206%207%207%2015%202l-1-1c-1-2-1-2%201-2%201%200%202%200%201-1l-2-10-2-1-1-2v-3c0-1%200-2-1-1h-6l-2-1-1-1v2m-203%205c-2%200-3%207-1%207l6%201-3%201c-4-1-4-2-1%2011l3%2016c2%2011%202%2011%2017%208%206-1%206-1%203-11l-4-15c-2-8-1-7-7-6l-6%202-1-8c-1-7-2-8-6-6m-80%204a193%20193%200%2001-21%205l2%204%201-1c-1-2%201-2%202-1%202%201%202%202%201%203h-5c-1-3-7%200-7%203%200%202%200%203%205%203h5v5c1%206%201%206-5%207h-4l1%207-1%208c-2%201-2%204%201%207l1%206a117%20117%200%2000-2%2017%201042%201042%200%20013%2031c2%204%205%205%2019%202%2034-7%2035-8%2035-15a1182%201182%200%2000-11-73v10l-2%202%202%201c2-1%202-1%202%202l3%2023%203%2030-4-7%201%201%201-1-1-1-7-41c-5-37-4-34-8-34l-3%201-3%201-2-2%202-1h1l2-2v-1l-7%201m53%2016l-12%203%2010%2070%2044-9c1-1-3-27-4-28l-16%203a455%20455%200%2000-3-14c1%201%203%201%203-2h-2c-3%200-3%200-4-12l-3-12c-1-1-7%200-13%201m74%201l-2%201h-12c-2%200%200%204%203%204%204%201%205%205%201%205l-2%202c0%202%200%203%203%203l4%201%203%201c2%200%202%200%201-1-2-1-2-1%201-1%202%200%203%200%203-3%200-2%200-3-1-2l-3-1c-1-1-1-1%201-1s2%200%202-2c0-5-1-7-2-7v1m156%204l-5%202c-12%202-16%208-14%2018%203%2015%2010%2022%2021%2021%2020-2%2026-10%2019-26l-5-10c-3-3-12-6-13-5h-3M11%20143l-1%203c-2%200-1%2016%202%2016v1c-2%201-2%207%200%2013v2l3-3c3-3%203-3%202-10l-1-11c-1-15-1-14-3-14s-2%201-2%203m198%2012l-2%203c-3%201-3%201-2%208l3%206%202%201c1%202%205%200%205-2s3-3%203-1c1%203%205%201%204-1l-1-4c0-2-1-2-5%200h-9l-1-2%202-3c3-1%203-1%202-4l-1-1m-32%206c-9%202-10%203-8%208%201%202%201%202%206%202%209-1%2016-4%2016-6l-2-4c0-2-1-2-12%200&#x27;%20fill=&#x27;%23d3d3d3&#x27;%20fill-rule=&#x27;evenodd&#x27;/%3e%3c/svg%3e" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source type='image/webp' srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/d1b89/hero.webp 236w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/5c64a/hero.webp 472w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/51c15/hero.webp 944w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/aef6e/hero.webp 1416w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/d5b8e/hero.webp 1600w" sizes="(max-width: 944px) 100vw, 944px" /><source srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/a616c/hero.jpg 236w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/f0f4a/hero.jpg 472w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/7a1e9/hero.jpg 944w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/85143/hero.jpg 1416w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/c252f/hero.jpg 1600w" sizes="(max-width: 944px) 100vw, 944px" /><img loading="lazy" sizes="(max-width: 944px) 100vw, 944px" srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/a616c/hero.jpg 236w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/f0f4a/hero.jpg 472w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/7a1e9/hero.jpg 944w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/85143/hero.jpg 1416w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/c252f/hero.jpg 1600w" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/071ade72ad3e58fb6f638b90c2b47ab3/7a1e9/hero.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div><style data-emotion-css="11anwtr">.css-11anwtr{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;width:100%;max-width:944px;margin:20px auto 0 auto;}@media (max-width:33.75em){.css-11anwtr{width:calc(100vw - 40px);}}</style><div class="css-11anwtr e1mhnqxm1"><style data-emotion-css="1j080gq">.css-1j080gq{color:var(--theme-ui-colors-gray,#999);padding-right:10px;}</style><p class="css-1j080gq e1mhnqxm0">封面来自 </p><div><a href="https://zh.ifixit.com/Guide/MacBook+Pro+16-Inch+2019+%E6%8B%86%E8%A7%A3/128106">IFIX</a></div></div></div><style data-emotion-css="145b7r6">.css-145b7r6{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:0 auto;max-width:1140px;}@media (max-width:80em){.css-145b7r6{display:none;}}</style><aside class="css-145b7r6 elwfz3v0"><style data-emotion-css="18dj233">.css-18dj233{position:absolute;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-transform:translateY(0px);-ms-transform:translateY(0px);transform:translateY(0px);top:0px;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;height:100vh;z-index:3;opacity:0;visibility:hidden;-webkit-transition:opacity 0.2s linear,visibility 0.4s linear;transition:opacity 0.2s linear,visibility 0.4s linear;}</style><div class="css-18dj233 elwfz3v1"><div><style data-emotion-css="155spwp">.css-155spwp{-webkit-user-select:initial;-moz-user-select:initial;-ms-user-select:initial;user-select:initial;pointer-events:initial;opacity:1;-webkit-transition:opacity 0.25s;transition:opacity 0.25s;}</style><div class="css-155spwp ednpv3g0"><style data-emotion-css="1cix3d7">.css-1cix3d7{position:relative;outline:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}.css-1cix3d7:hover .e1ys13yp0{opacity:1;}</style><div tabindex="-1" class="css-1cix3d7 e1ys13yp1"><style data-emotion-css="1egir6j">.css-1egir6j{position:absolute;top:-26px;left:-4px;}.css-1egir6j:hover{cursor:pointer;}.css-1egir6j svg path{fill:var(--theme-ui-colors-progress-complete,#000);}</style><div class="css-1egir6j e1ys13yp8"><svg width="9" height="12" viewBox="0 0 9 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.85355 0.646446C4.65829 0.451184 4.34171 0.451184 4.14645 0.646446L0.964467 3.82843C0.769204 4.02369 0.769204 4.34027 0.964467 4.53553C1.15973 4.7308 1.47631 4.7308 1.67157 4.53553L4.5 1.70711L7.32843 4.53553C7.52369 4.7308 7.84027 4.7308 8.03553 4.53553C8.2308 4.34027 8.2308 4.02369 8.03553 3.82843L4.85355 0.646446ZM5 12L5 1L4 1L4 12L5 12Z"></path></svg></div><style data-emotion-css="1sjbzrv">.css-1sjbzrv{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:1px;height:calc(88vh - 40px);max-height:520px;outline:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}</style><div class="css-1sjbzrv e1ys13yp9"></div><div style="top:unset;transform:rotate(180deg);padding-bottom:3px" class="css-1egir6j e1ys13yp8"><svg width="9" height="12" viewBox="0 0 9 12" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.85355 0.646446C4.65829 0.451184 4.34171 0.451184 4.14645 0.646446L0.964467 3.82843C0.769204 4.02369 0.769204 4.34027 0.964467 4.53553C1.15973 4.7308 1.47631 4.7308 1.67157 4.53553L4.5 1.70711L7.32843 4.53553C7.52369 4.7308 7.84027 4.7308 8.03553 4.53553C8.2308 4.34027 8.2308 4.02369 8.03553 3.82843L4.85355 0.646446ZM5 12L5 1L4 1L4 12L5 12Z"></path></svg></div></div></div></div></div></aside><style data-emotion-css="19mic43">.css-19mic43{position:relative;padding-top:60px;-webkit-transition:background 0.2s linear;transition:background 0.2s linear;text-align:center;}@media (min-width:33.8125em){.css-19mic43{display:none;}}</style><div class="css-19mic43 ea3ehcj1"><style data-emotion-css="gmuwbf">.css-gmuwbf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}</style><div class="css-gmuwbf e1s15a8f0"><style data-emotion-css="1yxfb37">.css-1yxfb37{opacity:0.5;position:relative;z-index:200000000;border-radius:5px;width:40px;height:25px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-transition:opacity 0.3s ease;transition:opacity 0.3s ease;margin-left:30px;}.css-1yxfb37:hover{opacity:1;}@media (max-width:45.9375em){.css-1yxfb37{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-transform:scale(0.9);-ms-transform:scale(0.9);transform:scale(0.9);margin:0 15px;}.css-1yxfb37:hover{opacity:0.5;}}</style><button data-a11y="false" aria-label="Copy URL to clipboard" class="css-1yxfb37 e1s15a8f2"><svg width="24" height="20" viewBox="0 0 24 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 5C2 3.34328 3.34328 2 5 2H14C15.6567 2 17 3.34328 17 5V9C17 10.6567 15.6567 12 14 12H10C9.44771 12 9 12.4477 9 13C9 13.5523 9.44771 14 10 14H14C16.7613 14 19 11.7613 19 9V5C19 2.23872 16.7613 0 14 0H5C2.23872 0 0 2.23872 0 5V9C0 10.4938 0.656313 11.8361 1.6935 12.7509C2.10768 13.1163 2.73961 13.0767 3.10494 12.6625C3.47028 12.2483 3.43068 11.6164 3.0165 11.2511C2.39169 10.6999 2 9.89621 2 9V5ZM7 11C7 9.34328 8.34328 8 10 8H14C14.5523 8 15 7.55228 15 7C15 6.44772 14.5523 6 14 6H10C7.23872 6 5 8.23872 5 11V15C5 17.7613 7.23872 20 10 20H19C21.7613 20 24 17.7613 24 15V11C24 9.50621 23.3437 8.16393 22.3065 7.24906C21.8923 6.88372 21.2604 6.92332 20.8951 7.3375C20.5297 7.75168 20.5693 8.38361 20.9835 8.74894C21.6083 9.30007 22 10.1038 22 11V15C22 16.6567 20.6567 18 19 18H10C8.34328 18 7 16.6567 7 15V11Z" fill="black"></path></svg><div class="css-1fk2nj2 e1s15a8f1">复制成功</div></button><button aria-label="Toggle dark and light mode" class="css-1yxfb37 e1s15a8f2"><div class="css-5bwd48 e1s15a8f3"></div><style data-emotion-css="vi65x">.css-vi65x{position:absolute;right:-1px;top:-8px;height:24px;width:24px;border-radius:50%;border:0;background:var(--theme-ui-colors-background,#fefefe);-webkit-transform:translate(0,0);-ms-transform:translate(0,0);transform:translate(0,0);opacity:1;-webkit-transition:-webkit-transform 0.45s ease,background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);-webkit-transition:transform 0.45s ease,background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:transform 0.45s ease,background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);}</style><div class="css-vi65x e1s15a8f4"></div></button></div></div><style data-emotion-css="1j2ibf0">.css-1j2ibf0{position:relative;padding:160px 0 35px;padding-left:68px;-webkit-transition:background 0.2s linear;transition:background 0.2s linear;}@media (max-width:66.875em){.css-1j2ibf0{padding-left:53px;}}@media (max-width:45.9375em){.css-1j2ibf0{padding:70px 0 80px;}}@media (max-width:33.75em){.css-1j2ibf0{padding:60px 0;}}</style><article class="css-1j2ibf0 ea3ehcj2"><style data-emotion-css="1ixbngf">.css-1ixbngf{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-1ixbngf h1,.css-1ixbngf h2,.css-1ixbngf h3,.css-1ixbngf h4,.css-1ixbngf h5,.css-1ixbngf h6{margin:0 auto;}.css-1ixbngf h1,.css-1ixbngf h2{margin:25px auto 18px;}@media (max-width:45.9375em){.css-1ixbngf h1,.css-1ixbngf h2{margin:30px auto 18px;}}.css-1ixbngf h3{margin:20px auto 10px;}.css-1ixbngf h1,.css-1ixbngf h2,.css-1ixbngf h3,.css-1ixbngf h4,.css-1ixbngf h5,.css-1ixbngf h6{width:100%;max-width:680px;}@media (max-width:66.875em){.css-1ixbngf h1,.css-1ixbngf h2,.css-1ixbngf h3,.css-1ixbngf h4,.css-1ixbngf h5,.css-1ixbngf h6{max-width:507px;}}@media (max-width:45.9375em){.css-1ixbngf h1,.css-1ixbngf h2,.css-1ixbngf h3,.css-1ixbngf h4,.css-1ixbngf h5,.css-1ixbngf h6{max-width:486px;}}@media (max-width:33.75em){.css-1ixbngf h1,.css-1ixbngf h2,.css-1ixbngf h3,.css-1ixbngf h4,.css-1ixbngf h5,.css-1ixbngf h6{padding:0 20px;}}.css-1ixbngf .prism-code{overflow:auto;width:100%;max-width:744px;margin:0 auto;padding:46px 32px 32px 32px;font-size:14px;margin:15px auto 25px;border-radius:5px;font-family:"Dank Mono","Noto Sans Mono","Menlo","Roboto Mono","Consolas","Operator Mono","Monaco","source-code-pro","Courier New","SF Pro Display","-apple-system","BlinkMacSystemFont","San Francisco","Helvetica Neue","Helvetica","Ubuntu","Roboto","Noto","Segoe UI","Arial","PingFang SC" ,"Hiragino Sans GB" ,"Microsoft YaHei" ,"Heiti SC" ,"WenQuanYi Micro Hei",sans-serif,monospace;background:var(--theme-ui-colors-prism-background,#f0f5f5);}.css-1ixbngf .prism-code:hover{overflow:auto;}.css-1ixbngf .prism-code .token-line{border-left:3px solid transparent;}.css-1ixbngf .prism-code .token-line .token{color:var(--theme-ui-colors-prism-token,#24292eff);}.css-1ixbngf .prism-code .token-line .language-javascript{color:var(--theme-ui-colors-prism-languageJavascript,#e8696b);}.css-1ixbngf .prism-code .token-line .javascript{color:var(--theme-ui-colors-prism-javascript,#e8696b);}.css-1ixbngf .prism-code .token-line .background{color:var(--theme-ui-colors-prism-background,#f0f5f5);}.css-1ixbngf .prism-code .token-line .comment{color:var(--theme-ui-colors-prism-comment,#6a737d);}.css-1ixbngf .prism-code .token-line .string{color:var(--theme-ui-colors-prism-string,#032f62);}.css-1ixbngf .prism-code .token-line .var{color:var(--theme-ui-colors-prism-var,#005cc5);}.css-1ixbngf .prism-code .token-line .number{color:var(--theme-ui-colors-prism-number,#22863a);}.css-1ixbngf .prism-code .token-line .constant{color:var(--theme-ui-colors-prism-constant,#005cc5);}.css-1ixbngf .prism-code .token-line .plain{color:var(--theme-ui-colors-prism-plain,#032f62);}.css-1ixbngf .prism-code .token-line .doctype{color:var(--theme-ui-colors-prism-doctype,#e8696b);}.css-1ixbngf .prism-code .token-line .tag{color:var(--theme-ui-colors-prism-tag,#22863a);}.css-1ixbngf .prism-code .token-line .keyword{color:var(--theme-ui-colors-prism-keyword,#6f42c1);}.css-1ixbngf .prism-code .token-line .boolean{color:var(--theme-ui-colors-prism-boolean,#ff5874);}.css-1ixbngf .prism-code .token-line .function{color:var(--theme-ui-colors-prism-function,#6f42c1);}.css-1ixbngf .prism-code .token-line .parameter{color:var(--theme-ui-colors-prism-parameter,#E27F2D);}.css-1ixbngf .prism-code .token-line .class-name{color:var(--theme-ui-colors-prism-className,#6f42c1);}.css-1ixbngf .prism-code .token-line .attr-name{color:var(--theme-ui-colors-prism-attrName,#6f42c1);}.css-1ixbngf .prism-code .token-line .attr-value{color:var(--theme-ui-colors-prism-attrValue,#a8e2a8);}.css-1ixbngf .prism-code .token-line .interpolation{color:var(--theme-ui-colors-prism-interpolation,#032f62);}.css-1ixbngf .prism-code .token-line .punctuation{color:var(--theme-ui-colors-prism-punctuation,#d73a49);}.css-1ixbngf .prism-code .token-line .maybe-class-name{color:var(--theme-ui-colors-prism-maybe-class-name,#000);}.css-1ixbngf .prism-code .token-line .property{color:var(--theme-ui-colors-prism-property,#005cc5);}.css-1ixbngf .prism-code .token-line .property-access{color:var(--theme-ui-colors-prism-propertyAccess,#005cc5);}.css-1ixbngf .prism-code .token-line .namespace{color:var(--theme-ui-colors-prism-namespace,#b2ccd6);}.css-1ixbngf .prism-code .token-line .highlight{color:var(--theme-ui-colors-prism-highlight,fffbdd);}.css-1ixbngf .prism-code .token-line .highlight-border{color:var(--theme-ui-colors-prism-highlightBorder,#e1bde2);}.css-1ixbngf .prism-code .token-line .dom{color:var(--theme-ui-colors-prism-dom,#5F8DC3);}.css-1ixbngf .prism-code .token-line .operator{color:var(--theme-ui-colors-prism-operator,#24292eff);}.css-1ixbngf .prism-code .token-line .line-number{color:var(--theme-ui-colors-prism-lineNumber,#333);}.css-1ixbngf .prism-code .number-line{display:inline-block;width:32px;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;opacity:0.3;color:var(--theme-ui-colors-prism-lineNumber,#333);}@media (max-width:45.9375em){.css-1ixbngf .prism-code .number-line{opacity:0;width:0;}}.css-1ixbngf .prism-code .token-line.highlight-line{margin:0 -32px;padding:0 32px;background:var(--theme-ui-colors-prism-highlight,fffbdd);border-left:3px solid var(--theme-ui-colors-prism-highlightBorder,#e1bde2);}@media (max-width:45.9375em){.css-1ixbngf .prism-code .token-line.highlight-line{margin:0 -20px;padding:0 20px;}}.css-1ixbngf .prism-code .operator + .maybe-class-name{color:#ffcf74 !important;}.css-1ixbngf .prism-code .plain ~ .operator{color:#5fa8aa !important;}@media (max-width:66.875em){.css-1ixbngf .prism-code{left:-26px;}}@media (max-width:45.9375em){.css-1ixbngf .prism-code{max-width:526px;padding:20px 20px;left:0;}}@media (max-width:33.75em){.css-1ixbngf .prism-code{-webkit-text-size-adjust:none;text-size-adjust:none;border-radius:0;margin:0 auto 25px;padding:30px 20px 25px 20px;overflow:initial;width:unset;max-width:unset;float:left;min-width:100%;overflow:initial;position:relative;}}.css-1ixbngf .gatsby-resp-image-background-image{display:none !important;}.css-1ixbngf img{display:inline-block;position:relative;max-width:100%;height:auto;z-index:0;margin:15px auto 50px;border-radius:5px;}@media (max-width:45.9375em){.css-1ixbngf img{margin:10px auto 45px;}}.css-1ixbngf div.Image__Small{display:inline-block;position:relative;max-width:100%;height:auto;z-index:0;margin:15px auto 50px;border-radius:5px;width:100%;max-width:680px;}@media (max-width:45.9375em){.css-1ixbngf div.Image__Small{margin:10px auto 45px;}}@media (max-width:66.875em){.css-1ixbngf div.Image__Small{max-width:507px;}}@media (max-width:45.9375em){.css-1ixbngf div.Image__Small{max-width:486px;margin:0 auto 25px;}}@media (max-width:33.75em){.css-1ixbngf div.Image__Small{padding:0 20px;}}.css-1ixbngf .Image__Container{text-align:center;}.css-1ixbngf img.Image__With-Shadow{box-shadow:0px 15px 60px rgba(0,0,0,0.15);}.css-1ixbngf div.Image__Medium{position:relative;margin:15px auto 50px;width:100%;max-width:1004px;}@media (max-width:80em){.css-1ixbngf div.Image__Medium{left:-34px;}}@media (max-width:66.875em){.css-1ixbngf div.Image__Medium{left:-26px;}}@media (max-width:45.9375em){.css-1ixbngf div.Image__Medium{border-radius:0;left:0;margin:0 auto 25px;}.css-1ixbngf div.Image__Medium img{border-radius:0;}}.css-1ixbngf div.Image__Large{position:relative;left:-68px;width:100vw;max-width:100vw;margin:25px auto 60px;pointer-events:none;}.css-1ixbngf div.Image__Large img{border-radius:0;}@media (max-width:66.875em){.css-1ixbngf div.Image__Large{left:-53px;}}@media (max-width:45.9375em){.css-1ixbngf div.Image__Large{left:0;margin:0 auto 25px;}}</style><div class="css-1ixbngf e1nfwq1l1"><style data-emotion-css="v0s5vi">.css-v0s5vi{line-height:1.756;font-size:18px;color:var(--theme-ui-colors-text,#08080B);font-family:"SF Pro Display","-apple-system","BlinkMacSystemFont","San Francisco","Helvetica Neue","Helvetica","Ubuntu","Roboto","Noto","Segoe UI","Arial","PingFang SC" ,"Hiragino Sans GB" ,"Microsoft YaHei" ,"Heiti SC" ,"WenQuanYi Micro Hei",sans-serif;-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);margin:18px auto 18px;width:100%;max-width:680px;}.css-v0s5vi b{font-weight:800;}@media (max-width:66.875em){.css-v0s5vi{max-width:507px;}}@media (max-width:45.9375em){.css-v0s5vi{max-width:486px;margin:0 auto 25px;}}@media (max-width:33.75em){.css-v0s5vi{padding:0 20px;}}</style><p class="css-v0s5vi em5ola80">React 是目前最流行的前端框架，很多读者用 React 很溜，但想要深入学习 React 的原理就会被官方源码仓库代码绕的晕头转向。今天我们通过不依赖任何第三方库的方式，抛弃边界处理、性能优化、安全性等弱相关代码手写一个基础版的 React，供大家学习和理解 React 的核心原理。</p><p class="css-v0s5vi em5ola80"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1123px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:56.0106856634016%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/svg+xml,%3csvg%20xmlns=\&#x27;http://www.w3.org/2000/svg\&#x27;%20width=\&#x27;400\&#x27;%20height=\&#x27;224\&#x27;%3e%3cpath%20d=\&#x27;M0%201l10%201a1490%201490%200%200177%200c0-2-4-2-43-2L0%201m91%201l42%201a2207%202207%200%200017-3C98%200%2090%200%2091%202m121%200c0%202-1%203-2%203l-61%201a614%20614%200%2000-62%201L44%206H0v43l7%206c4%205%208%207%208%206l5%203%204%204h9c13%200%2013-1%2015-4l1-2v5h20c13%200%2019%200%2018-1l-6-1c-10%200-31-7-39-13-7-5-19-19-24-29-4-7-1-4%205%206%2016%2025%2033%2033%2069%2035l24%202%206%201h-7c-9%200-23%202-34%206l-27%205c-3%200-4%200-5%203v3l-1-3c0-2-1-3-5-3s-4%200-2%201c6%202%207%208%201%206-3-1-3-1-4%201%200%202-3%202-5%200-1-1-2%200-5%201s-6%201-6-1-4-1-5%201-1%202-2%201l-3-1c-4%200-1-4%206-6l6-2%201-1%204-2h3l-5-4c-4-2-5-2-16-2H0v14l1%2015v1l-1%2062v62h401v-63a1122%201122%200%2000-2-37l-1%201%201%201v3c0%204-2%202-2-2l-2-5c-1-3-2-3-4-2-3%201-3%201-5-1h-3l-1%201c-3%200-3%200-3%202v2l-2%203h-1l-1-2-1-2c-2%200-3-1-2-2%200-2%200-2-2-2l-2-1c3-4-5%200-8%204-1%202-2%201-1-2%201-2-1-3-3%200-1%202-13%203-17%200l-4-2c-1%201-9-1-9-2l3-1c6%201%2019%200%2020-1h1c2%202%2018-2%2017-4-1-1%200-3%201-5%202-4%202-4%203-2v4l4-2%204-2-2-2-4-2-1-2-4-3c-3-1-7-11-7-17l-1-4v-5c-1-2-2-2-12-2-27%202-32%202-32%201-1-1%204-1%2013-1%2012%200%2015%200%2016-2h12c3-1%204-10%201-11l-2-1c1-2-2-3-5-2s-3%201-3%206v6l-1-5v-8c0-3%200-3%203-2%206%202%2010-2%2011-9l2-6%201%202c-2%206-2%208-1%208l1-1%201-1c3%200%208-3%208-6l1-2v2c0%203%200%203%203%202l5-1h1v2l2%201%2013%2011c2%200%201-8-1-9v-2c2-2%202-4%201-4-7-1-7-1-7%204%200%203%200%204-1%203v-5c1-4%201-4%204-4%204%200%204-1%205-3l-1-3-5-1c0-2%201-2%203-1l2%201-1-2v-2c1%200%202-2%202-8l-1-7h-2c-1-1-2-2-5-1-3%200-3%200-1-2l6-1h3c-1-1-13-2-39-2h-37v32l-33%201a997%20997%200%2000-59%201l-1-30%207-2c5-1%204-1-7-1h-12l-3-1c-2%200-3%200-3%202m53-1c-14%201-27%202-32%204-2%200-2%201-2%2014l1%2014%207-1%2044-1c44%200%2039%202%2039-15%200-16%201-14-13-15a483%20483%200%2001-44%200m-50%2037a168%20168%200%20001%2039l1-49-2%2010m-40%203l-6%202c-5%201-6%204-4%209l1%206c-1%202%201%206%202%204l2%203%202%204-3%203-5%208-2%207-1%2016c1%2016%201%2018-3%2020-2%202-9%209-8%2010s9-3%208-4%200-2%201-3%202%200%205%203l6%203%207%201%207%202%205-1%206-4c7-6%2010-6%204%200l-3%204c0%202%206%200%2011-3%204-3%204-4%205-9%200-6%201-7%204-5%203%204%2013-3%2013-8%200-4-4-13-8-18-2-3-2-4-1-5%201-2%200-3-2-3-1%200-3-2-5-6-3-5-4-6-12-10-10-5-13-8-12-11v-6c-1-4-3-5-3-2l-2-2v-4l1-2h-3c0-1-5-1-7%201m99%2011a71%2071%200%2001-1%2010c0%202%200%203-2%203l-3-1h-2l-2%201%201-2v-2c-2-2-3-1-3%202%200%204-2%205-11%205h-8l7%201c8%200%209%202%205%203l-1%202c0%202%200%202-2%202-1%200-2-1-1-2%200-2%200-2-1%200-2%203-4%203-2%200l-1-2-4%209%201%202%202-2%202-2%204-1%201-1c1%201-1%2010-3%2011v11c0%2011%201%2014%204%2014s1%202-3%203c-13%203-20%207-20%2010%200%201%206%204%207%203l1%201%201%201v-7c-2-3%200-2%202%202%202%203%202%203%206%203h6l3%203h2c-1-1%200-2%201-2l1%202%202-1%201-1v-1l1-2%201-1%201%201c-1%201%200%202%202%202%203%201%205%200%205-2l-2-2c0-2%200-2%202-1l3%202h-1l-1%201%202%202c2%200%202-1%201-2%200-3%200-2%205%202l4%202%203-2c3%200%203%200%202-2-1-1-1-1%202-1%202%201%203%201%204-1l4-3c5-2%206-3%202-2-6%201-25-7-27-10l2-5%202-1c1%202%203-1%202-4%200-2%200-2%201-1%201%202%201%202%201%200l1-4%201-6c3-9%202-15-1-17-5-2-2-4%2012-4l13-1-25%201-5-1-5-2-1-9v-8l-1%204M0%2060v9l10-1h10l-5-4-10-9-5-4v9m59%209H49v4l1%204%206-1c6%200%2023-4%2030-6%204-2%204-2-27-1m-32%201c2%202%2010%206%2016%206l5%201v-7l-11-1c-10%200-11%200-10%201m24%2031v1c0%201-1%202-3%201l-4%202c-2%203-3%2014-2%2015l1-3%201-3c1-1%203%202%203%205l1%202%201-1h1c1%201%201-1%202-13%201-5%200-8-1-6m-23%2039l1%208c2%208%204%209%206%202l1-4%201%204c2%207%204%206%205-2%202-8%202-9%201-9-2%200-2%201-3%207-1%201-1%200-2-3l-2-4c-1%200-3%203-3%206s-1%202-2-2c-1-3-2-5-3-3m186%2023l-1%202c0%201-1%202-3%202-3%201-5%205-3%208%201%203%202%203%205%203h4v-16l-2%201m-168%202l-2%202c-3%200-5%202-5%206s2%205%206%205h4v-7l-1-8-2%202m92%200c0%201-1%202-3%202-3%201-5%205-3%208%201%203%202%203%205%203h4v-7l-1-8-2%202\&#x27;%20fill=\&#x27;%23d3d3d3\&#x27;%20fill-rule=\&#x27;evenodd\&#x27;/%3e%3c/svg%3e&#x27;);background-size:cover;display:block"></span>
  <img tabindex="0" class="Image__Zoom" alt="feynman" title="feynman" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/ce23c7cf8e379def723702b40a603495/8b7fe/feynman.png" srcSet="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/ce23c7cf8e379def723702b40a603495/8b7fe/feynman.png 1123w" sizes="(max-width: 1123px) 100vw, 1123px" style="cursor:zoom-in;display:block;margin:0 auto;width:100%" loading="lazy"/>
    </span></p><p class="css-v0s5vi em5ola80">本文实现的是包含现代 React 最新特性 <style data-emotion-css="14mpdsk">.css-14mpdsk{-webkit-transition:background-size 0.5s;transition:background-size 0.5s;color:var(--theme-ui-colors-accent,#6166DC);-webkit-text-decoration:none;text-decoration:none;background-image:linear-gradient(currentColor,currentColor);background-position:0 90%;background-repeat:no-repeat;background-size:0 1px;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:baseline;-webkit-box-align:baseline;-ms-flex-align:baseline;align-items:baseline;}.css-14mpdsk:visited{color:var(--theme-ui-colors-accent,#6166DC);opacity:0.85;}.css-14mpdsk:hover,.css-14mpdsk:focus{background-size:100% 1px;}</style><a rel="noopener noreferrer" href="https://reactjs.org/docs/hooks-intro.html" class="css-14mpdsk e1cfml80"><style data-emotion-css="uux7qa">.css-uux7qa{padding-right:5px;}</style><span class="css-uux7qa e1cfml81">Hooks</span></a> 和 <a rel="noopener noreferrer" href="https://reactjs.org/docs/concurrent-mode-intro.html" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">Concurrent Mode</span></a> 的版本，传统 class 组件的方式稍有不同，不影响理解核心原理。本文函数、变量等标识符命名都和官方尽量贴近，方便以后深入官方源码。</p><p class="css-v0s5vi em5ola80">建议桌面端浏览本文，并且跟着文章手动敲一遍代码加深理解。每完成一个完整功能最后都会有对应的完整代码放在 <a rel="noopener noreferrer" href="https://codesandbox.io/" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">CodeSandbox（在线开发环境）</span></a>，如果对代码有疑问，可以先查看完整代码，打断点调试下。</p><p class="css-v0s5vi em5ola80"><strong class="css-0">目录总览</strong></p><style data-emotion-css="vb6hou">.css-vb6hou{list-style:none;counter-reset:list;color:var(--theme-ui-colors-text,#08080B);position:relative;padding:15px 0 30px 30px;-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);margin:0 auto;font-size:18px;width:100%;max-width:680px;}@media (max-width:66.875em){.css-vb6hou{max-width:507px;}}@media (max-width:45.9375em){.css-vb6hou{max-width:486px;padding-left:0px;}}@media (max-width:33.75em){.css-vb6hou{padding-left:20px;}}.css-vb6hou li{position:relative;padding-bottom:15px;}@media (max-width:45.9375em){.css-vb6hou li{padding-left:30px;}}@media (max-width:33.75em){.css-vb6hou li{padding-left:30px;}}@media (max-width:45.9375em){.css-vb6hou li p{padding:0;}}.css-vb6hou li >:not(ol,ul){display:inline;}.css-vb6hou li::before{width:3rem;display:inline-block;position:absolute;color:var(--theme-ui-colors-text,#08080B);}.css-vb6hou li::before{content:'';position:absolute;left:-30px;top:8px;height:8px;width:8px;background:var(--theme-ui-colors-text,#08080B);}@media (max-width:45.9375em){.css-vb6hou li::before{left:0;}}</style><ul class="css-vb6hou eowy95v0"><li class="css-0">0: 从一次最简单的 React 渲染说起</li><li class="css-0">I: 实现 createElement 函数</li><li class="css-0">II: 实现 render 函数</li><li class="css-0">III: 并发模式 / Concurrent Mode</li><li class="css-0">IV: Fibers 数据结构</li><li class="css-0">V: render 和 commit 阶段</li><li class="css-0">VI: 更新和删除节点/Reconciliation</li><li class="css-0">VII: 函数组件</li><li class="css-0">VIII: 函数组件 Hooks</li></ul><style data-emotion-css="1534ren">.css-1534ren{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1534ren svg{visibility:hidden;}.css-1534ren:hover svg,.css-1534ren:active svg{visibility:visible;}@media (max-width:66.875em){.css-1534ren svg{width:18px;height:18px;visibility:visible;}.css-1534ren a{margin-left:-20px;}}</style><style data-emotion-css="3a8jv7">.css-3a8jv7{font-size:32px;line-height:1.333;word-break:keep-all;font-weight:bold;color:var(--theme-ui-colors-primary,#000);font-family:Georgia,"Noto Serif CJK SC","Source Han Serif SC","Source Han Serif CN","Songti SC","SimSun","STSong","AR PL Sungti",serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}@media (max-width:66.875em){.css-3a8jv7{font-size:21px;}}@media (max-width:45.9375em){.css-3a8jv7{font-size:24px;line-height:1.45;}}@media (max-width:33.75em){.css-3a8jv7{font-size:22px;}}.css-3a8jv7 svg{visibility:hidden;}.css-3a8jv7:hover svg,.css-3a8jv7:active svg{visibility:visible;}@media (max-width:66.875em){.css-3a8jv7 svg{width:18px;height:18px;visibility:visible;}.css-3a8jv7 a{margin-left:-20px;}}</style><h2 id="0: 从一次最简单的 React 渲染说起" class="css-3a8jv7 e1deern01"><style data-emotion-css="1m33aeh">.css-1m33aeh{padding-right:4px;margin-left:-28px;line-height:1;}</style><a href="#0: 从一次最简单的 React 渲染说起" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>0: 从一次最简单的 React 渲染说起</h2><style data-emotion-css="xqe627">.css-xqe627{overflow:auto;}@media (max-width:33.75em){.css-xqe627{overflow-x:scroll;}}</style><div class="css-xqe627 eg6okne0"><pre class="prism-code language-jsx" style="position:relative"><style data-emotion-css="gbt9ey">.css-gbt9ey{position:absolute;top:0;padding:5px 10px;font-size:13px;text-align:right;color:var(--theme-ui-colors-codeLabel,#08080B);font-weight:700;-webkit-letter-spacing:0.8px;-moz-letter-spacing:0.8px;-ms-letter-spacing:0.8px;letter-spacing:0.8px;text-transform:uppercase;border-radius:0 0 5px 5px;background:var(--theme-ui-colors-highlight,#dedff8);box-shadow:0 1px 5px rgba(255,255,255,0.35);}</style><div class="css-gbt9ey eg6okne1">jsx</div><style data-emotion-css="1hl1i47">.css-1hl1i47{position:absolute;right:5px;top:5px;padding:8px 12px 7px;border-radius:5px;color:#6f7177;-webkit-transition:background 0.3s ease;transition:background 0.3s ease;}.css-1hl1i47:hover{background:#fefefe;}.css-1hl1i47[data-a11y='true']:focus::after{content:'';position:absolute;left:-2%;top:-2%;width:104%;height:104%;border:2px solid var(--theme-ui-colors-accent,#6166DC);border-radius:5px;background:rgba(255,255,255,0.01);}@media (max-width:45.9375em){.css-1hl1i47{display:none;}}</style><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">h1</span><span class="token tag"> </span><span class="token tag attr-name">title</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">hello</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">Hello World</span><span class="token operator">!</span><span class="token tag punctuation">&lt;/</span><span class="token tag">h1</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> container </span><span class="token operator">=</span><span class="token plain"> document</span><span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">ReactDOM</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">,</span><span class="token plain"> container</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80">上面这三行代码是一个再简单不过的 React 应用：在 <style data-emotion-css="1udlz9w">.css-1udlz9w{word-wrap:break-word;padding:0 8px;background:var(--theme-ui-colors-prism-background,#f0f5f5);}</style><code class="css-1udlz9w e1g3grwc0">root</code> 根结点上渲染一个 <code class="css-1udlz9w e1g3grwc0">Hello World!</code> h1 节点。</p><p class="css-v0s5vi em5ola80">第一步的目标是<strong class="css-0">用原生 DOM 方式替换 React 代码</strong>。</p><style data-emotion-css="18vmug7">.css-18vmug7{font-size:24px;line-height:1.45;word-break:keep-all;font-weight:bold;color:var(--theme-ui-colors-primary,#000);font-family:Georgia,"Noto Serif CJK SC","Source Han Serif SC","Source Han Serif CN","Songti SC","SimSun","STSong","AR PL Sungti",serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}@media (max-width:45.9375em){.css-18vmug7{font-size:22px;}}@media (max-width:33.75em){.css-18vmug7{font-size:20px;}}.css-18vmug7 svg{visibility:hidden;}.css-18vmug7:hover svg,.css-18vmug7:active svg{visibility:visible;}@media (max-width:66.875em){.css-18vmug7 svg{width:18px;height:18px;visibility:visible;}.css-18vmug7 a{margin-left:-20px;}}</style><h3 id="JSX" class="css-18vmug7 e1deern02"><a href="#JSX" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>JSX</h3><p class="css-v0s5vi em5ola80">熟悉 React 的读者都知道，我们直接在组件渲染的时候返回一段类似 html 模版的结构，这个就是所谓的 <a rel="noopener noreferrer" href="https://reactjs.org/docs/introducing-jsx.html" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">JSX</span></a>。JSX 本质上还是 JS，是语法糖而不是 html 模版（相比 html 模版要学习千奇百怪的语法比如：<code class="css-1udlz9w e1g3grwc0">{{#if value}}</code>，JSX 可以直接使用 JS 原生的 <code class="css-1udlz9w e1g3grwc0">&amp;&amp; || map reduce</code> 等语法更易学表达能力也更强）。一般需要 <a rel="noopener noreferrer" href="https://babeljs.io/" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">babel</span></a> 配合<a rel="noopener noreferrer" href="https://babeljs.io/docs/en/babel-plugin-transform-react-jsx" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">@babel/plugin-transform-react-jsx</span></a> 插件（babel 转换过程不是本文重点，感兴趣可以阅读<a rel="noopener noreferrer" href="https://github.com/babel/babel/blob/master/packages/babel-plugin-transform-react-jsx/README.md#babelplugin-transform-react-jsx" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">插件源码</span></a>）转换成调用 <code class="css-1udlz9w e1g3grwc0">React.createElement</code>，函数入参如下：</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  </span><span class="token punctuation">[</span><span class="token plain">props</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">  </span><span class="token punctuation">[</span><span class="token spread operator">...</span><span class="token plain">children</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain"></span><span class="token punctuation">)</span></div></pre></div><p class="css-v0s5vi em5ola80">例如上面的例子中的 <code class="css-1udlz9w e1g3grwc0">&lt;h1 title=&quot;hello&quot;&gt;Hello World!&lt;/h1&gt;</code>，换成 <code class="css-1udlz9w e1g3grwc0">createElement</code> 调用就是：</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token string">&#x27;h1&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> title</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;hello&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">  </span><span class="token string">&#x27;Hello World!&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80"><code class="css-1udlz9w e1g3grwc0">React.createElement</code> 返回一个包含元素（element）信息的对象，即：</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  props</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">    title</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">    </span><span class="token comment">// createElement 第三个及之后参数移到 props.children</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">    children</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80">react 官方实现还包括了很多额外属性，简单起见本文未涉及，参看<a rel="noopener noreferrer" href="https://github.com/facebook/react/blob/f4cc45ce962adc9f307690e1d5cfa28a288418eb/packages/react/src/ReactElement.js#L111" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">官方定义</span></a>。</p><p class="css-v0s5vi em5ola80">这个对象描述了 React 创建一个节点（node）所需要的信息，<code class="css-1udlz9w e1g3grwc0">type</code> 就是 DOM 节点的名字，比如这里是 <code class="css-1udlz9w e1g3grwc0">h1</code>，也可以是函数组件，后面会讲到。<code class="css-1udlz9w e1g3grwc0">props</code> 包含所有元素的属性（比如 title）和特殊属性 children，children 可以包含其他元素，从根到叶也就能构成一颗完整的树，也就是描述了整个 UI 界面。</p><p class="css-v0s5vi em5ola80"><strong class="css-0">为了避免含义不清，“元素”特指 “React elements”，“节点”特指 “DOM elements”。</strong></p><h3 id="ReactDOM.render" class="css-18vmug7 e1deern02"><a href="#ReactDOM.render" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>ReactDOM.render</h3><p class="css-v0s5vi em5ola80">下面替换掉 <code class="css-1udlz9w e1g3grwc0">ReactDOM.render</code> 调用，这里 React 会把元素更新到 DOM。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  props</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">    title</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">    children</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">9</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> container </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">11</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> node </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">node</span><span class="token punctuation">[</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">13</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">14</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> text </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain">text</span><span class="token punctuation">[</span><span class="token string">&quot;nodeValue&quot;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">16</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">17</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">text</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">18</span><span class="token plain">container</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80">对比元素对象，首先用 <code class="css-1udlz9w e1g3grwc0">element.type</code> 创建节点，再把非 children 属性（这里是 title）赋值给节点。</p><p class="css-v0s5vi em5ola80">然后创建 children 节点，由于 children 是字符串，故创建 <code class="css-1udlz9w e1g3grwc0">textNode</code> 节点，并把字符串赋值给 <code class="css-1udlz9w e1g3grwc0">nodeValue</code>，这里之所以用 <code class="css-1udlz9w e1g3grwc0">createTextNode</code> 而不是 <code class="css-1udlz9w e1g3grwc0">innerText</code>，是为了方便之后统一处理。</p><p class="css-v0s5vi em5ola80">再把 children 节点 text 插到元素节点的子节点上，最后把元素节点插到根结点即完成了这次 React 的替换。</p><style data-emotion-css="1ag8dzj">.css-1ag8dzj{border-left-width:8px;border-left-style:solid;border-radius:2px;font-style:italic;margin:0 auto 16px auto;width:100%;max-width:744px;border-left-color:var(--theme-ui-colors-accent,#6166DC);background-color:var(--theme-ui-colors-background,#fefefe);}</style><style data-emotion-css="162w1lo">.css-162w1lo{border-left-width:8px;border-left-style:solid;border-radius:2px;font-style:italic;margin:0 auto 16px auto;width:100%;max-width:744px;border-left-color:var(--theme-ui-colors-accent,#6166DC);background-color:var(--theme-ui-colors-background,#fefefe);}@media (max-width:33.75em){.css-162w1lo > p{margin:0 auto;}}</style><style data-emotion-css="qjx5m">.css-qjx5m{box-sizing:border-box;margin:0;min-width:0;padding:16px;padding-left:12px;border-left-width:4px;border-left-style:solid;border-left-color:var(--theme-ui-colors-primary,#000);border-radius:4px;background-color:var(--theme-ui-colors-highlight,#dedff8);border-left-width:8px;border-left-style:solid;border-radius:2px;font-style:italic;margin:0 auto 16px auto;width:100%;max-width:744px;border-left-color:var(--theme-ui-colors-accent,#6166DC);background-color:var(--theme-ui-colors-background,#fefefe);}@media (max-width:33.75em){.css-qjx5m > p{margin:0 auto;}}</style><div class="evpml4g0 css-qjx5m"><p class="css-v0s5vi em5ola80">像上面代码 <code class="css-1udlz9w e1g3grwc0">element</code> 这样 JSX 转成的描述 UI 界面的对象就是所谓的 <strong class="css-0">虚拟 DOM</strong>，相对的 <code class="css-1udlz9w e1g3grwc0">node</code> 即 <strong class="css-0">真实 DOM</strong>。<code class="css-1udlz9w e1g3grwc0">render/渲染</code> 过程就是把虚拟 DOM 转换成真实 DOM 的过程。</p></div><style data-emotion-css="xu77su">.css-xu77su{position:relative;width:100%;max-width:680px;margin:50px auto;border:0;height:14.36px;background-image:url("data:image/svg+xml,%3Csvg width='10' height='15' viewBox='0 0 10 15' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='0.567383' y='14.1777' width='16' height='1' transform='rotate(-60 0.567383 14.1777)' fill='%232D2E33'/%3E%3C/svg%3E");background-repeat:repeat-x;box-sizing:border-box;background-position:center;}@media (max-width:66.875em){.css-xu77su{max-width:507px;}}@media (max-width:45.9375em){.css-xu77su{max-width:486px;}}@media (max-width:33.75em){.css-xu77su{padding:0 20px;}}@media (max-width:45.9375em){.css-xu77su{width:calc(100vw - 40px);margin:0px auto 50px;}}</style><hr class="css-xu77su e17vjet20"/><h2 id="I: 实现 createElement 函数" class="css-3a8jv7 e1deern01"><a href="#I: 实现 createElement 函数" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>I: 实现 createElement 函数</h2><p class="css-v0s5vi em5ola80">第一步首先实现 <code class="css-1udlz9w e1g3grwc0">createElement</code> 函数，把 JSX 转换成 JS。以下面这个新的渲染为例，<code class="css-1udlz9w e1g3grwc0">createElement</code> 就是把 JSX 结构转成元素描述对象。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-jsx" style="position:relative"><div class="css-gbt9ey eg6okne1">jsx</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">id</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">foo</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">a</span><span class="token tag punctuation">&gt;</span><span class="token plain">bar</span><span class="token tag punctuation">&lt;/</span><span class="token tag">a</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">b</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">  </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain"></span><span class="token comment">// 等价转换 👇</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> React</span><span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">  </span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> id</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;foo&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain">  React</span><span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">  React</span><span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">13</span><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">14</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> container </span><span class="token operator">=</span><span class="token plain"> document</span><span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">16</span><span class="token plain">ReactDOM</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">,</span><span class="token plain"> container</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80">就像之前示例那样，<code class="css-1udlz9w e1g3grwc0">createElement</code> 返回一个包含 type 和 props 的元素对象，描述节点信息。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token comment">// 这里用了最新 ECMAScript 剩余参数和展开语法（Rest parameter/Spread syntax），</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain"></span><span class="token comment">// 参考 https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Spread_syntax</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain"></span><span class="token comment">// 注意：这里 children 始终是数组</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token parameter punctuation">,</span><span class="token parameter"> props</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter operator">...</span><span class="token parameter">children</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">    type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">    props</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">      </span><span class="token spread operator">...</span><span class="token plain">props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">      children</span><span class="token punctuation">:</span><span class="token plain"> children</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain">        </span><span class="token keyword">typeof</span><span class="token plain"> child </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;object&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> child</span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">          </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token function">createTextElement</span><span class="token punctuation">(</span><span class="token plain">child</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">13</span><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">14</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">16</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">17</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">18</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createTextElement</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">19</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">20</span><span class="token plain">    type</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;TEXT_ELEMENT&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">21</span><span class="token plain">    props</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">22</span><span class="token plain">      nodeValue</span><span class="token punctuation">:</span><span class="token plain"> text</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">23</span><span class="token plain">      children</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">24</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">25</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">26</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p class="css-v0s5vi em5ola80">children 可能包含字符串或者数字这类基础类型值，给这里值包裹成 <code class="css-1udlz9w e1g3grwc0">TEXT_ELEMENT</code> 特殊类型，方便后面统一处理。</p><div class="evpml4g0 css-qjx5m"><p class="css-v0s5vi em5ola80">  注意：React 并不会包裹字符串这类值，如果没有 children 也不会创建空数组，这里简单起见，统一这样处理可以简化我们的代码。</p></div><p class="css-v0s5vi em5ola80">我们把本文的框架叫做 <code class="css-1udlz9w e1g3grwc0">redact</code>，以区别 <code class="css-1udlz9w e1g3grwc0">react</code>。示例 app 如下。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">Redact</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> id</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;foo&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">  </span><span class="token maybe-class-name">Redact</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">  </span><span class="token maybe-class-name">Redact</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> container </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain"></span><span class="token comment">// 后面实现 render 方法</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain"></span><span class="token maybe-class-name">RedactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">,</span><span class="token plain"> container</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80">但是我们还是习惯用 JSX 来写组件，这里还能用吗？答案是能的，只需要加一行注释即可。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token doc-comment comment">/** </span><span class="token doc-comment comment keyword">@jsx</span><span class="token doc-comment comment"> Redact.createElement */</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  </span><span class="token operator">&lt;</span><span class="token plain">div id</span><span class="token operator">=</span><span class="token string">&quot;foo&quot;</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">a</span><span class="token operator">&gt;</span><span class="token plain">bar</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">a</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">b </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">  </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> container </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain"></span><span class="token maybe-class-name">RedactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">,</span><span class="token plain"> container</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80">注意第一行注释 <code class="css-1udlz9w e1g3grwc0">@jsx</code> 告诉 babel 用 <code class="css-1udlz9w e1g3grwc0">Redact.createElement</code> 替换默认的 <code class="css-1udlz9w e1g3grwc0">React.createElement</code>。或者直接修改 <code class="css-1udlz9w e1g3grwc0">.babelrc</code> 配置文件的 <code class="css-1udlz9w e1g3grwc0">pragma</code> 项，就不用每个 JSX 文件都添加注释了。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-json" style="position:relative"><div class="css-gbt9ey eg6okne1">json</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token property">&quot;presets&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">    </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">      </span><span class="token string">&quot;@babel/preset-react&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">        </span><span class="token property">&quot;pragma&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;Redact.createElement&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">    </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">  </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><hr class="css-xu77su e17vjet20"/><h2 id="II: 实现 render 函数" class="css-3a8jv7 e1deern01"><a href="#II: 实现 render 函数" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>II: 实现 render 函数</h2><p class="css-v0s5vi em5ola80">实现我们的 render 函数，目前只需要添加节点到 DOM，删除和更新操作后面再加。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token parameter punctuation">,</span><span class="token parameter"> container</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token comment">// 创建节点</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dom </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">    element</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;TEXT_ELEMENT&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">      </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">  </span><span class="token comment">// 赋值属性（props）</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">isProperty</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> key </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&quot;children&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token plain">isProperty</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">13</span><span class="token plain">      dom</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">14</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">16</span><span class="token plain">  </span><span class="token comment">// 递归遍历子节点</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">17</span><span class="token plain">  element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">child</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">18</span><span class="token plain">    </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token plain">child</span><span class="token punctuation">,</span><span class="token plain"> dom</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">19</span><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">20</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">21</span><span class="token plain">  </span><span class="token comment">// 插入父节点</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">22</span><span class="token plain">  container</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">23</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p class="css-v0s5vi em5ola80">上面的代码放在了 CodeSandbox（在线开发环境），项目基于 <a rel="noopener noreferrer" href="https://create-react-app.dev/docs/getting-started/" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">Create React App</span></a> 脚手架，试一试改下面的 JSX 代码验证下。</p><iframe src="https://codesandbox.io/embed/adoring-lewin-93gyy?fontsize=14&amp;hidenavigation=1&amp;theme=dark" style="width:100%;max-width:800px;height:500px;border:0;border-radius:4px;overflow:hidden" title="redact-1" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe><hr class="css-xu77su e17vjet20"/><h2 id="III: 并发模式 / Concurrent Mode" class="css-3a8jv7 e1deern01"><a href="#III: 并发模式 / Concurrent Mode" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>III: 并发模式 / Concurrent Mode</h2><p class="css-v0s5vi em5ola80">在我们深入其他 React 功能之前，先对代码重构，引入 React 最新的并发模式（截止本文发表该功能还未正式发布）。</p><p class="css-v0s5vi em5ola80">可能读者会疑惑我们目前连最基本的组件状态更新都还没实现就先实现并发模式，其实目前代码逻辑还十分简单，现在重构，比之后实现所有功能再回头要容易很多，所谓积重难返就是这个道理。</p><p class="css-v0s5vi em5ola80">有经验的开发者很容易发现上面的 <code class="css-1udlz9w e1g3grwc0">render</code> 代码有一个问题，渲染子节点时递归遍历了整棵树，当页面非常复杂时很容易阻塞主线程，我们都知道每个页面是单线程的（不考虑 worker 线程），主线程阻塞会导致页面不能及时响应高优先级操作，如用户点击事件或者渲染动画，页面给用户 “很卡，难用” 的负面印象，这肯定不是我们想要的。</p><p class="css-v0s5vi em5ola80">因此，理想情况下，我们应该把 <code class="css-1udlz9w e1g3grwc0">render</code> 拆成更细分的单元，每完成一个单元的工作，允许浏览器打断渲染响应更高优先级的的工作，这个过程即 “并发模式”。</p><p class="css-v0s5vi em5ola80">这里我们用 <a rel="noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">requestIdleCallback</span></a> 这个浏览器 API 来实现。这个 API 有点类似 <code class="css-1udlz9w e1g3grwc0">setTimeout</code>，不过不是我们告诉浏览器什么时候执行回调函数，而是浏览器在线程空闲（idle）的时侯主动执行回调函数。</p><p class="css-v0s5vi em5ola80">React 目前已经<a rel="noopener noreferrer" href="https://github.com/facebook/react/issues/11171#issuecomment-417349573" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">不用这个 API</span></a> 了，而是自己实现调度算法 <a rel="noopener noreferrer" href="https://github.com/facebook/react/tree/master/packages/scheduler" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">调度器/scheduler</span></a>。但它们核心思路是类似的，简化起见用 requestIdleCallback 足矣。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">let</span><span class="token plain"> nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">3</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> shouldYield </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">shouldYield</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">    nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">      nextUnitOfWork</span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">    </span><span class="token comment">// 回调函数入参 deadline 可以告诉我们在这个渲染周期还剩多少时间可用</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain">    </span><span class="token comment">// 剩余时间小于1毫秒就退出回调，等待浏览器再次空闲</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain">    shouldYield </span><span class="token operator">=</span><span class="token plain"> deadline</span><span class="token punctuation">.</span><span class="token method function property-access">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">13</span><span class="token plain">  </span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token plain">workLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">14</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">16</span><span class="token plain"></span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token plain">workLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">17</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">18</span><span class="token plain"></span><span class="token comment">// 注意，这个函数执行完本次单元任务之后要返回下一个单元任务</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">19</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">20</span><span class="token plain">  </span><span class="token comment">// TODO</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">21</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p class="css-v0s5vi em5ola80">这就是我们简易并发模式的实现，渲染任务拆分为多个任务单元交给 <code class="css-1udlz9w e1g3grwc0">performUnitOfWork</code> 执行，具体怎么拆分任务？答案是 “Fibers”。</p><h2 id="IV: Fibers 数据结构" class="css-3a8jv7 e1deern01"><a href="#IV: Fibers 数据结构" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>IV: Fibers 数据结构</h2><p class="css-v0s5vi em5ola80">为了方便描述渲染树和单元任务，React 设计了一种数据结构 “fiber 树”。每个元素都是一个 fiber，每个 fiber 就是一个单元任务。</p><p class="css-v0s5vi em5ola80">假如我们渲染如下这样一棵树：</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token maybe-class-name">Redact</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">h1</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">p </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">a </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">h1</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">h2 </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">  </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">  container</span></div><div class="token-line"><span class="number-line">10</span><span class="token plain"></span><span class="token punctuation">)</span></div></pre></div><p class="css-v0s5vi em5ola80">用 Fiber 树来描述就是：</p><div style="background:#202226;max-width:680px;margin:0 auto" class="css-0">
  <span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:274px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:116.05839416058394%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/svg+xml,%3csvg%20xmlns=\&#x27;http://www.w3.org/2000/svg\&#x27;%20width=\&#x27;400\&#x27;%20height=\&#x27;464\&#x27;%3e%3cpath%20d=\&#x27;M147%2027c-6%206-3%2015%205%2015%204%200%206-1%207-4l1-3%201-3c0-2%200-2-1-1s-1%201-1-1-1-2-2-2l-1-1c1-1-2-3-4-3s-4%201-5%203m1%200v4c0%202%200%202-1%201-1-2-1-2-1%201%200%206%205%209%2010%207%202-1%201-11%200-10h-1c1-2-2-4-4-4l-3%201m26%2043c-2%202-2%203%200%203l1%2026%201%2025%201-25%201-26%202%202c4%203%203%200-1-3-3-4-4-4-5-2M28%20154c-5%205-1%2012%207%2012%206%200%209-3%209-8%200-3-1-4-2-5v4c0%205-1%207-5%207-2%200-2-1-2-6%200-7%200-7-2-7-1%200-4%201-5%203m2%2017l-1%201c-3%200-4%207-1%2010%201%202%203%202%207%202%206%201%209-2%209-7%200-4-2-8-3-6v10l-4%201c-2%200-2%200-2-5l-1-5-1%205c0%204%200%205-2%205s-3-2-3-6l2-2%201-1%202-2c2-1%202-1%200-1l-3%201m145%2033c-2%201-3%202-2%203l1-1c1-4%202%203%202%2026l1%2025%201-26c0-20%201-25%202-25%202%200%201-1-1-3s-2-2-4%201m63%203c0%203%200%204%201%202l1-3%2027%2026a469%20469%200%2000-25-28l4-1%203-1-6-1h-5v6M28%20242c-5%205-1%2012%207%2012%206%200%209-2%209-8%200-3-2-7-3-5v10l-4%201c-2%200-2%200-2-5v-6c0-2-5-1-7%201m4%2017c-4%201-6%204-6%208l1%204h-4c-3%200-4%200-3%201h24l-3-2c-2%202-12%201-12-1v-7c2-1%2011-2%2011%200l1%201%201%203%201%203c2%200%201-6-1-8s-7-3-10-2m333%2028l-1%203%203-1c1-3%208-4%209-1s-1%206-6%2012l-5%206c1%202%2015%202%2015%201l-6-1c-7%200-7-1-3-4%206-6%209-14%205-17-2-2-9-1-11%202m-75%208l-25%201-26%201%2025%201c23%200%2030%201%2026%202l-1%201%203-1%203-3-2-2c-2-2-3-2-3%200m-116%2042c-2%202-2%203%200%203l1%2026%201%2025%201-25%201-26%202%202c4%203%203%200-1-3-3-4-4-4-5-2m185%2088l3%201c3%200%204%201%204%203s0%203-4%203c-11%202-10%2010%201%2010h6v-8c-1-5-1-7-3-8-2-2-7-3-7-1m-69%203l-25%201-26%201%2025%201%2027%201c0%201%201%201%202-1%202-1%202-1%200-3s-3-3-3%200\&#x27;%20fill=\&#x27;%23d3d3d3\&#x27;%20fill-rule=\&#x27;evenodd\&#x27;/%3e%3c/svg%3e&#x27;);background-size:cover;display:block"></span>
  <img tabindex="0" class="Image__Zoom" alt="fiber0" title="fiber0" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/de664d437c94d478778b965c66c91f99/1800c/fiber0.png" srcSet="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/de664d437c94d478778b965c66c91f99/1800c/fiber0.png 274w" sizes="(max-width: 274px) 100vw, 274px" style="cursor:zoom-in;display:block;margin:0 auto;width:100%" loading="lazy"/>
    </span></div><p class="css-v0s5vi em5ola80">在 <code class="css-1udlz9w e1g3grwc0">render</code> 函数我们创建<strong class="css-0">根 fiber</strong>，再把它设为 <code class="css-1udlz9w e1g3grwc0">nextUnitOfWork</code>。在 workLoop 函数把 <code class="css-1udlz9w e1g3grwc0">nextUnitOfWork</code> 给 <code class="css-1udlz9w e1g3grwc0">performUnitOfWork</code> 执行，主要包含以下三步：</p><style data-emotion-css="17nimfq">.css-17nimfq{list-style:none;counter-reset:list;color:var(--theme-ui-colors-text,#08080B);position:relative;padding:15px 0 30px 30px;margin:0 auto;-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);font-size:18px;width:100%;max-width:680px;}@media (max-width:66.875em){.css-17nimfq{max-width:507px;}}@media (max-width:45.9375em){.css-17nimfq{max-width:486px;padding-left:0px;}}@media (max-width:33.75em){.css-17nimfq{padding-left:20px;}}.css-17nimfq li{position:relative;padding-bottom:15px;}@media (max-width:45.9375em){.css-17nimfq li{padding-left:30px;}}@media (max-width:33.75em){.css-17nimfq li{padding-left:30px;}}@media (max-width:45.9375em){.css-17nimfq li p{padding:0;}}.css-17nimfq li >:not(ol,ul){display:inline;}.css-17nimfq li::before{width:3rem;display:inline-block;position:absolute;color:var(--theme-ui-colors-text,#08080B);}.css-17nimfq li::before{counter-increment:list;content:counter(list) '.';font-weight:600;position:absolute;left:-3rem;top:-0.3rem;font-size:2rem;}@media (max-width:45.9375em){.css-17nimfq li::before{left:0;}}</style><ol class="css-17nimfq e2dt7l30"><li class="css-0">把元素添加到 DOM</li><li class="css-0">为元素的后代创建 fiber 节点</li><li class="css-0">选择下一个单元任务，并返回</li></ol><p class="css-v0s5vi em5ola80">为了完成这些目标需要设计的数据结构方便找到下一个任务单元。<strong class="css-0">所以每个 fiber 直接链接它的第一个子节点(child)，子节点链接它的兄弟节点(sibling)，兄弟节点链接到父节点(parent)。</strong>示意图如下(注意不同节点之间的高亮箭头)：</p><div style="background:#202226;max-width:680px;margin:0 auto" class="css-0">
  <span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:274px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:116.05839416058394%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/svg+xml,%3csvg%20xmlns=\&#x27;http://www.w3.org/2000/svg\&#x27;%20width=\&#x27;400\&#x27;%20height=\&#x27;464\&#x27;%3e%3cpath%20d=\&#x27;M338%2051c0%2010%200%2011%203%2010l1-6c0-5%200-5%203-5%202%200%202%200%202%206l1%206V48l-3-1c-2%200-3%200-3-2l-2-3c-2%200-2%201-2%209m37-8l-1%203c0%203%200%203-2%202-3-2-6%201-6%207-1%206%201%207%206%207h5V52c0-9-1-11-2-9m-73%204l1%202-17%201c-25%201-25%202%200%203l17%201-1%202%205-4c0-2-5-6-5-5M148%2094l-1%2026-3-2c-4-4-3%200%201%204%205%205%205%205%2011-2%202-3%202-5-1-2l-3%202-1-25c0-19-1-25-2-26l-1%2025m197%2028c0%209%200%209%202%209%208%201%209%200%209-6%200-5-1-6-5-7l-4-2-1-4-1%2010m43-2c-4%205-1%2013%205%2012h2c0%203%200%203-3%203-4-1-5%200-2%202%203%201%207-1%207-3%200-1%200-2%201-1l1-7-1-7-4-1c-3%200-4%200-6%202M31%20152c-9%204-5%2014%204%2014%206%200%209-3%209-8s-2-5-2%200c0%204-1%205-3%205-4%202-4%201-4-6l-1-6-3%201m117%2076c0%2023-1%2029-3%2024%200-2-3-3-3-2l3%205%204%204%205-4%203-5-3%201-2%202-1-25-1-26c-2%200-2%204-2%2026m139%2062l2%203c3%203%200%203-24%203l-26%201%2026%201%2025%201-3%203-1%202%206-4%203-3-4-5c-3-3-4-3-4-2m-138%2047l-1%2026v25l-3-2c-4-5-5-2%200%203s4%205%209%200%204-8%200-3l-3%202v-25c0-24%200-28-2-26m138%2086l2%202%201%202c0%202-3%202-25%202l-26%201%2026%201%2025%201-2%202c-3%204%200%203%204%200l3-4-4-5c-3-3-4-3-4-2\&#x27;%20fill=\&#x27;%23d3d3d3\&#x27;%20fill-rule=\&#x27;evenodd\&#x27;/%3e%3c/svg%3e&#x27;);background-size:cover;display:block"></span>
  <img tabindex="0" class="Image__Zoom" alt="fiber1" title="fiber1" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a88a3ec01855349c14302f6da28e2b0c/1800c/fiber1.png" srcSet="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/a88a3ec01855349c14302f6da28e2b0c/1800c/fiber1.png 274w" sizes="(max-width: 274px) 100vw, 274px" style="cursor:zoom-in;display:block;margin:0 auto;width:100%" loading="lazy"/>
    </span></div><p class="css-v0s5vi em5ola80">当我们完成了一个 fiber 的单元任务，如果他有一个 <code class="css-1udlz9w e1g3grwc0">子节点/child</code> 则这个节点作为 <code class="css-1udlz9w e1g3grwc0">nextUnitOfWork</code>。如下图所示，当完成 <code class="css-1udlz9w e1g3grwc0">div</code> 单元任务之后，下一个单元任务就是 <code class="css-1udlz9w e1g3grwc0">h1</code>。</p><div style="background:#202226;max-width:680px;margin:0 auto" class="css-0">
  <span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:274px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:116.05839416058394%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/svg+xml,%3csvg%20xmlns=\&#x27;http://www.w3.org/2000/svg\&#x27;%20width=\&#x27;400\&#x27;%20height=\&#x27;464\&#x27;%3e%3cpath%20d=\&#x27;M338%2052c0%208%201%2010%202%2010%202%200%202-1%202-6%200-6%200-6%203-6%202%200%202%200%202%206l1%206V48l-3-1c-2%200-3%200-3-2s-1-3-2-3c-2%200-2%201-2%2010m37-9l-1%203c0%202%200%202-2%201-4%200-6%203-6%208-1%206%201%207%206%207h5V52c0-9-1-11-2-9m-73%204l1%202-17%201c-25%201-26%202-1%203l18%201-1%201v1l5-4c0-2-5-6-5-5M172%2072l-3%204%203-1%202-1%201%2025%201%2025%201-25%201-26%202%202c4%203%203%200%200-3-4-5-4-5-8%200m-23-2l-1%2026-1%2025-2-2-3-2c0%201%201%203%204%205l4%204%203-4c5-4%205-7%200-3l-2%201V95c0-23%200-27-2-25m196%2052c0%209%200%209%202%209%208%201%209%200%209-6%200-4-2-7-5-7l-3-3c-2-5-3-3-3%207m43-2c-4%205-1%2013%205%2012h2c0%203%200%203-4%203-2-1-3%200-3%201l1%202h1l4-1%203-3c0-1%200-2%201-1l1-7-1-7-4-1c-3%200-4%200-6%202M31%20152c-9%204-5%2014%204%2014%206%200%209-3%209-8l-1-4-1%204c0%203-1%204-2%205-4%202-5%201-5-5%200-7%200-7-4-6m142%2053l-3%204%203-1%202-2%201%2026%201%2025%201-25%201-26%202%202%203%201-7-8-4%204m65-3c-2%201-1%2010%201%2010l1-3%201-3%2026%2026a1025%201025%200%2000-24-28l3-1%203-1h-11m-90%2026c0%2023-1%2029-3%2024%200-2-3-3-3-2l3%205c5%205%205%204%2011-2%202-3%201-5-2-2l-2%202-1-25-1-26c-2%200-2%204-2%2026M28%20242c-3%203-3%207%200%2010s12%203%2014%200c2-2%203-9%201-11s-3%200-1%203c2%204-1%208-5%208-2%200-2%200-2-5v-6c0-2-5-1-7%201m259%2048l1%203%202%202-25%201-26%201%2026%201%2025%201-2%203c-4%204%200%203%204-1l3-4-4-4-4-3m-115%2049c-5%204-5%207-1%203l3-1%201%2025%201%2025%201-25%201-26%202%202%203%201-7-8-4%204m65-3c0%203%200%2011%202%2011l1-4v-3a2188%202188%200%200128%2025l-25-27%203-1%203-1c-1-2-11-1-12%200m-89%2027l-1%2025-1-1-2-2c-3-2-2%200%202%204l3%204%204-4c5-4%205-7%200-3l-2%201a3439%203439%200%2001-1-50c-2%200-2%203-2%2026m139%2060l2%203c4%202-1%203-25%203l-25%201%2026%201%2025%201-2%203c-4%203%200%202%204-2l3-3-4-4-4-3\&#x27;%20fill=\&#x27;%23d3d3d3\&#x27;%20fill-rule=\&#x27;evenodd\&#x27;/%3e%3c/svg%3e&#x27;);background-size:cover;display:block"></span>
  <img tabindex="0" class="Image__Zoom" alt="fiber2" title="fiber2" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c1105e4f7fc7292d91c78caee258d20d/1800c/fiber2.png" srcSet="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c1105e4f7fc7292d91c78caee258d20d/1800c/fiber2.png 274w" sizes="(max-width: 274px) 100vw, 274px" style="cursor:zoom-in;display:block;margin:0 auto;width:100%" loading="lazy"/>
    </span></div><p class="css-v0s5vi em5ola80">如果一个 fiber 没有 <code class="css-1udlz9w e1g3grwc0">child</code>，我们用 <code class="css-1udlz9w e1g3grwc0">兄弟节点/sibling</code> 作为下一个任务单元。如下图所示，<code class="css-1udlz9w e1g3grwc0">p</code> 节点没有 <code class="css-1udlz9w e1g3grwc0">child</code> 而有 <code class="css-1udlz9w e1g3grwc0">sibling</code>，所以下一个任务单元是 <code class="css-1udlz9w e1g3grwc0">a</code> 节点。</p><div style="background:#202226;max-width:680px;margin:0 auto" class="css-0">
  <span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:274px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:116.05839416058394%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/svg+xml,%3csvg%20xmlns=\&#x27;http://www.w3.org/2000/svg\&#x27;%20width=\&#x27;400\&#x27;%20height=\&#x27;464\&#x27;%3e%3cpath%20d=\&#x27;M338%2052c0%208%201%2010%202%2010%202%200%202-1%202-6%200-6%200-6%203-6%202%200%202%200%202%206l1%206V48l-3-1c-2%200-3%200-3-2s-1-3-2-3c-2%200-2%201-2%2010m37-9l-1%203c0%202%200%202-2%201-4%200-6%203-6%208-1%206%201%207%206%207h5V52c0-9-1-11-2-9m-73%204l1%202-17%201c-25%201-26%202-1%203l18%201-1%201v1l5-4c0-2-5-6-5-5M172%2072l-3%204%203-1%202-1%201%2025%201%2025%201-25%201-26%202%202c4%203%203%200%200-3-4-5-4-5-8%200m-23-2l-1%2026-1%2025-2-2-3-2c0%201%201%203%204%205l4%204%203-4c5-4%205-7%200-3l-2%201V95c0-23%200-27-2-25m196%2052c0%209%200%209%202%209%208%201%209%200%209-6%200-4-2-7-5-7l-3-3c-2-5-3-3-3%207m43-2c-4%205-1%2013%205%2012h2c0%203%200%203-4%203-2-1-3%200-3%201l1%202h1l4-1%203-3c0-1%200-2%201-1l1-7-1-7-4-1c-3%200-4%200-6%202M31%20152c-9%204-5%2014%204%2014%206%200%209-3%209-8l-1-4-1%204c0%203-1%204-2%205-4%202-5%201-5-5%200-7%200-7-4-6m142%2053l-3%204%203-1%202-2%201%2026%201%2025%201-25%201-26%202%202%203%201-7-8-4%204m65-3c-2%201-1%2010%201%2010l1-3%201-3%2026%2026a1025%201025%200%2000-24-28l3-1%203-1h-11m-90%2025l-1%2026-2-2c-4-3-3%200%201%204l4%204%203-4c4-4%205-7%201-4l-3%202v-25c0-19-1-25-2-26l-1%2025M28%20242c-3%203-3%207%200%2010s12%203%2014%200c2-2%203-9%201-11s-3%200-1%203c2%204-1%208-5%208-2%200-2%200-2-5v-6c0-2-5-1-7%201m259%2048l1%203%202%202-25%201-26%201%2026%201%2025%201-2%203c-4%204%200%203%204-1l3-4-4-4-4-3m-115%2049c-5%204-5%207-1%203l3-1%201%2025%201%2025%201-25%201-26%202%202%203%201-7-8-4%204m65-3c0%203%200%2011%202%2011l1-4v-3a2188%202188%200%200128%2025l-25-27%203-1%203-1c-1-2-11-1-12%200m-89%2027l-1%2025-1-1-2-2c-3-2-2%200%202%204l3%204%204-4c5-4%205-7%200-3l-2%201a3439%203439%200%2001-1-50c-2%200-2%203-2%2026m139%2060l2%202%201%202c0%202-3%202-25%202l-26%201%2026%201%2025%201-3%203-1%202%206-4%203-3-2-3-3-3v-1l-1-1h-1c-1-1-1-1-1%201\&#x27;%20fill=\&#x27;%23d3d3d3\&#x27;%20fill-rule=\&#x27;evenodd\&#x27;/%3e%3c/svg%3e&#x27;);background-size:cover;display:block"></span>
  <img tabindex="0" class="Image__Zoom" alt="fiber3" title="fiber3" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c8bdcc17706e9ab06233c980ed9cf007/1800c/fiber3.png" srcSet="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c8bdcc17706e9ab06233c980ed9cf007/1800c/fiber3.png 274w" sizes="(max-width: 274px) 100vw, 274px" style="cursor:zoom-in;display:block;margin:0 auto;width:100%" loading="lazy"/>
    </span></div><p class="css-v0s5vi em5ola80">如果一个 fiber 既没有 <code class="css-1udlz9w e1g3grwc0">child</code> 也没有 <code class="css-1udlz9w e1g3grwc0">sibling</code>，则找到父节点的兄弟节点，。如下图所示的 <code class="css-1udlz9w e1g3grwc0">a</code> 和 <code class="css-1udlz9w e1g3grwc0">h2</code>。</p><div style="background:#202226;max-width:680px;margin:0 auto" class="css-0">
  <span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:274px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:116.05839416058394%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/svg+xml,%3csvg%20xmlns=\&#x27;http://www.w3.org/2000/svg\&#x27;%20width=\&#x27;400\&#x27;%20height=\&#x27;464\&#x27;%3e%3cpath%20d=\&#x27;M338%2052c0%208%201%2010%202%2010%202%200%202-1%202-6%200-6%200-6%203-6%202%200%202%200%202%206l1%206V48l-3-1c-2%200-3%200-3-2s-1-3-2-3c-2%200-2%201-2%2010m37-9l-1%203c0%202%200%202-2%201-4%200-6%203-6%208-1%206%201%207%206%207h5V52c0-9-1-11-2-9m-73%204l1%202-17%201c-25%201-26%202-1%203l18%201-1%201v1l5-4c0-2-5-6-5-5M172%2072l-3%204%203-1%202-1%201%2025%201%2025%201-25%201-26%202%202c4%203%203%200%200-3-4-5-4-5-8%200m-23-2l-1%2026-1%2025-2-2-3-2c0%201%201%203%204%205l4%204%203-4c5-4%205-7%200-3l-2%201V95c0-23%200-27-2-25m196%2052c0%209%200%209%202%209%208%201%209%200%209-6%200-4-2-7-5-7l-3-3c-2-5-3-3-3%207m43-2c-4%205-1%2013%205%2012h2c0%203%200%203-4%203-2-1-3%200-3%201l1%202h1l4-1%203-3c0-1%200-2%201-1l1-7-1-7-4-1c-3%200-4%200-6%202M31%20152c-9%204-5%2014%204%2014%206%200%209-3%209-8l-1-4-1%204c0%203-1%204-2%205-4%202-5%201-5-5%200-7%200-7-4-6m142%2053l-3%204%203-1%202-2%201%2026%201%2025%201-25%201-26%202%202%203%201-7-8-4%204m65-3c-2%201-1%2010%201%2010l1-3%201-3%2026%2026a1025%201025%200%2000-24-28l3-1%203-1h-11m-90%2025l-1%2026-2-2c-4-3-3%200%201%204l4%204%203-4c4-4%205-7%201-4l-3%202v-25c0-19-1-25-2-26l-1%2025M28%20242c-3%203-3%207%200%2010s12%203%2014%200c2-2%203-9%201-11s-3%200-1%203c2%204-1%208-5%208-2%200-2%200-2-5v-6c0-2-5-1-7%201m259%2048l2%203c3%203%200%203-24%203l-26%201%2026%201%2025%201-3%203c-2%201-2%202-1%202l6-3%203-4-4-4c-3-4-4-4-4-3m-115%2049c-5%204-5%207-1%203l3-1%201%2025%201%2025%201-25%201-26%202%202%203%201-7-8-4%204m-24%2024l-1%2025-1-1-2-2c-3-2-2%200%202%204l3%204%204-4c5-4%205-7%200-3l-2%201a3439%203439%200%2001-1-50c-2%200-2%203-2%2026m139%2060l2%203c4%202-1%203-25%203l-25%201%2026%201%2025%201-2%203c-4%203%200%202%204-2l3-3-4-4-4-3\&#x27;%20fill=\&#x27;%23d3d3d3\&#x27;%20fill-rule=\&#x27;evenodd\&#x27;/%3e%3c/svg%3e&#x27;);background-size:cover;display:block"></span>
  <img tabindex="0" class="Image__Zoom" alt="fiber4" title="fiber4" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/19c304dcb3824b14722691ded539ecdb/1800c/fiber4.png" srcSet="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/19c304dcb3824b14722691ded539ecdb/1800c/fiber4.png 274w" sizes="(max-width: 274px) 100vw, 274px" style="cursor:zoom-in;display:block;margin:0 auto;width:100%" loading="lazy"/>
    </span></div><p class="css-v0s5vi em5ola80">如果父节点没有兄弟节点，则继续往上找，直到找到一个兄弟节点或者到达 fiber 根结点。到达根结点即意味本次 <code class="css-1udlz9w e1g3grwc0">render</code> 任务全部完成。学过算法的同学对这个过程肯定很熟悉，这是典型的深度优先搜索遍历（DFS/depth first search）。</p><p class="css-v0s5vi em5ola80">把这个思路用代码表达如下：</p><p class="css-v0s5vi em5ola80"><em class="css-0">提示：代码差异部分左边框有高亮，下同</em></p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token comment">// 之前 render 的逻辑挪到这个函数</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">2</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createDom</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">3</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dom </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">4</span><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string">&quot;TEXT_ELEMENT&quot;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">5</span><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">6</span><span class="token plain">      </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">7</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">8</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">isProperty</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> key </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&quot;children&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">9</span><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">10</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token plain">isProperty</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">11</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">12</span><span class="token plain">      dom</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">13</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">14</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">15</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> dom</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">16</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">17</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token parameter punctuation">,</span><span class="token parameter"> container</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">18</span><span class="token plain">  </span><span class="token comment">// 创建根 fiber，设为下一次的单元任务</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">19</span><span class="token plain">  nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">20</span><span class="token plain">    dom</span><span class="token punctuation">:</span><span class="token plain"> container</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">21</span><span class="token plain">    props</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">22</span><span class="token plain">      children</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">element</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">23</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">24</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">25</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">26</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">27</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">28</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">29</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> shouldYield </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">30</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">shouldYield</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">31</span><span class="token plain">    nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">32</span><span class="token plain">    shouldYield </span><span class="token operator">=</span><span class="token plain"> deadline</span><span class="token punctuation">.</span><span class="token method function property-access">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">33</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">34</span><span class="token plain">  </span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token plain">workLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">35</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">36</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">37</span><span class="token plain"></span><span class="token comment">// 一旦浏览器空闲，就触发执行单元任务</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">38</span><span class="token plain"></span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token plain">workLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">39</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">40</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">41</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">42</span><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createDom</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">43</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">44</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">45</span><span class="token plain">  </span><span class="token comment">// 子节点 DOM 插到父节点之后</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">46</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">47</span><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">48</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">49</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">50</span><span class="token plain">  </span><span class="token comment">// 为每个子元素创建新的 fiber</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">51</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> elements </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">52</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">53</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> prevSibling </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">54</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">55</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">&lt;</span><span class="token plain"> elements</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">56</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> elements</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">57</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">58</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">59</span><span class="token plain">      type</span><span class="token punctuation">:</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">60</span><span class="token plain">      props</span><span class="token punctuation">:</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">61</span><span class="token plain">      parent</span><span class="token punctuation">:</span><span class="token plain"> fiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">62</span><span class="token plain">      dom</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">63</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">64</span><span class="token plain">    </span><span class="token comment">// 根据上面的图示，父节点只链接第一个子节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">65</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">66</span><span class="token plain">      fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">67</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">68</span><span class="token plain">      </span><span class="token comment">// 兄节点链接弟节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">69</span><span class="token plain">      prevSibling</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">70</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">71</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">72</span><span class="token plain">    prevSibling </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">73</span><span class="token plain">    index</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">74</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">75</span><span class="token plain">  </span><span class="token comment">// 返回下一个任务单元（fiber）</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">76</span><span class="token plain">  </span><span class="token comment">// 有子节点直接返回</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">77</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">78</span><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">79</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">80</span><span class="token plain">  </span><span class="token comment">// 没有子节点则找兄弟节点，兄弟节点也没有找父节点的兄弟节点，</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">81</span><span class="token plain">  </span><span class="token comment">// 循环遍历直至找到为止</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">82</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> nextFiber </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">83</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">84</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">85</span><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> nextFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">86</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">87</span><span class="token plain">    nextFiber </span><span class="token operator">=</span><span class="token plain"> nextFiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">88</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">89</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">90</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><hr class="css-xu77su e17vjet20"/><h2 id="V: render 和 commit 阶段" class="css-3a8jv7 e1deern01"><a href="#V: render 和 commit 阶段" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>V: render 和 commit 阶段</h2><p class="css-v0s5vi em5ola80">我们的代码还有一个问题。</p><p class="css-v0s5vi em5ola80">每完成一个任务单元都把节点添加到 DOM 上。请记住，浏览器是可以打断渲染流程的，如果还没渲染完整棵树就把节点添加到 DOM，用户会看到残缺不全的 UI 界面，给人一种很不专业的印象，这肯定不是我们想要的。因此需要重构节点添加到 DOM 这部分代码，整棵树（fiber）渲染完成之后再一次性添加到 DOM，即 React commit 阶段。</p><p class="css-v0s5vi em5ola80">具体来说，去掉 <code class="css-1udlz9w e1g3grwc0">performUnitOfWork</code> 的 <code class="css-1udlz9w e1g3grwc0">fiber.parent.dom.appendChild</code> 代码，换成如下代码。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createDom</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dom </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">==</span><span class="token plain"> </span><span class="token string">&quot;TEXT_ELEMENT&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">      </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">isProperty</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> key </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&quot;children&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token plain">isProperty</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain">      dom</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">13</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">14</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> dom</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">16</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">17</span><span class="token plain"></span><span class="token comment">// 新增函数，提交根结点到 DOM</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">18</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">19</span><span class="token plain">  </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">wipRoot</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">20</span><span class="token plain">  wipRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">21</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">22</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">23</span><span class="token plain"></span><span class="token comment">// 新增子函数</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">24</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">25</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">26</span><span class="token plain">    </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">27</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">28</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> domParent </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">29</span><span class="token plain">  domParent</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">30</span><span class="token plain">  </span><span class="token comment">// 递归子节点和兄弟节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">31</span><span class="token plain">  </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">32</span><span class="token plain">  </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">33</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">34</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">35</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token parameter punctuation">,</span><span class="token parameter"> container</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">36</span><span class="token plain">  </span><span class="token comment">// render 时记录 wipRoot</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">37</span><span class="token plain">  wipRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">38</span><span class="token plain">    dom</span><span class="token punctuation">:</span><span class="token plain"> container</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">39</span><span class="token plain">    props</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">40</span><span class="token plain">      children</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">element</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">41</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">42</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">43</span><span class="token plain">  nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> wipRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">44</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">45</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">46</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">47</span><span class="token plain"></span><span class="token comment">// 新增变量，跟踪渲染进行中的根 fiber</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">48</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> wipRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">49</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">50</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">51</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> shouldYield </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">52</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">shouldYield</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">53</span><span class="token plain">    nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">54</span><span class="token plain">      nextUnitOfWork</span></div><div class="token-line"><span class="number-line">55</span><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">56</span><span class="token plain">    shouldYield </span><span class="token operator">=</span><span class="token plain"> deadline</span><span class="token punctuation">.</span><span class="token method function property-access">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">57</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">58</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">59</span><span class="token plain">  </span><span class="token comment">// 当 nextUnitOfWork 为空则表示渲染 fiber 树完成了，</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">60</span><span class="token plain">  </span><span class="token comment">// 可以提交到 DOM 了</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">61</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">nextUnitOfWork </span><span class="token operator">&amp;&amp;</span><span class="token plain"> wipRoot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">62</span><span class="token plain">    </span><span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">63</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">64</span><span class="token plain">  </span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token plain">workLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">65</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">66</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">67</span><span class="token plain">​</span><span class="token comment">// 一旦浏览器空闲，就触发执行单元任务</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">68</span><span class="token plain"></span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token plain">workLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">69</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">70</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">71</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">72</span><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createDom</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">73</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">74</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">75</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> elements </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">76</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">77</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> prevSibling </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">78</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">79</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">&lt;</span><span class="token plain"> elements</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">80</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> elements</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">81</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">82</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">83</span><span class="token plain">      type</span><span class="token punctuation">:</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">84</span><span class="token plain">      props</span><span class="token punctuation">:</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">85</span><span class="token plain">      parent</span><span class="token punctuation">:</span><span class="token plain"> fiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">86</span><span class="token plain">      dom</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">87</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">88</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">89</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">90</span><span class="token plain">      fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">91</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">92</span><span class="token plain">      prevSibling</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">93</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">94</span><span class="token plain">​</span></div><div class="token-line"><span class="number-line">95</span><span class="token plain">    prevSibling </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">96</span><span class="token plain">    index</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">97</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">98</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">99</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">100</span><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">101</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">102</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">103</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> nextFiber </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">104</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">105</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">106</span><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> nextFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">107</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">108</span><span class="token plain">    nextFiber </span><span class="token operator">=</span><span class="token plain"> nextFiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">109</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">110</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><hr class="css-xu77su e17vjet20"/><h2 id="VI: 更新和删除节点/Reconciliation" class="css-3a8jv7 e1deern01"><a href="#VI: 更新和删除节点/Reconciliation" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>VI: 更新和删除节点/Reconciliation</h2><p class="css-v0s5vi em5ola80">目前我们只添加节点到 DOM，还没考虑更新和删除节点的情况。要处理这2种情况，需要对比上次渲染的 fiber 和当前渲染的 fiber 的差异，根据差异决定是更新还是删除节点。React 把这个过程叫 <code class="css-1udlz9w e1g3grwc0">Reconciliation</code>。</p><p class="css-v0s5vi em5ola80">因此我们需要保存上一次渲染之后的 fiber 树，我们把这棵树叫 <code class="css-1udlz9w e1g3grwc0">currentRoot</code>。同时，给每个 fiber 节点添加 <code class="css-1udlz9w e1g3grwc0">alternate</code> 属性，指向上一次渲染的 fiber。</p><p class="css-v0s5vi em5ola80">代码较多，建议按 <code class="css-1udlz9w e1g3grwc0">render ⟶ workLoop ⟶ performUnitOfWork ⟶ reconcileChildren ⟶ workLoop ⟶ commitRoot ⟶ commitWork ⟶ updateDom</code> 顺序阅读。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createDom</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> dom </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;TEXT_ELEMENT&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createTextNode</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">      </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">7</span><span class="token plain">  </span><span class="token function">updateDom</span><span class="token punctuation">(</span><span class="token plain">dom</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> dom</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">12</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">isEvent</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> key</span><span class="token punctuation">.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;on&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">13</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">isProperty</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> key </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token string">&quot;children&quot;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token function">isEvent</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">14</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">isNew</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">prev</span><span class="token parameter punctuation">,</span><span class="token parameter"> next</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> prev</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> next</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">15</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">isGone</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">prev</span><span class="token parameter punctuation">,</span><span class="token parameter"> next</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token plain">key </span><span class="token keyword">in</span><span class="token plain"> next</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">16</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">17</span><span class="token plain"></span><span class="token comment">// 新增函数，更新 DOM 节点属性</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">18</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateDom</span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token parameter punctuation">,</span><span class="token parameter"> prevProps </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter punctuation">{</span><span class="token parameter punctuation">}</span><span class="token parameter punctuation">,</span><span class="token parameter"> nextProps </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter punctuation">{</span><span class="token parameter punctuation">}</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">19</span><span class="token plain">  </span><span class="token comment">// 以 “on” 开头的属性作为事件要特别处理</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">20</span><span class="token plain">  </span><span class="token comment">// 移除旧的或者变化了的的事件处理函数</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">21</span><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">prevProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">22</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token plain">isEvent</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">23</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token plain">key </span><span class="token keyword">in</span><span class="token plain"> nextProps</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> </span><span class="token function">isNew</span><span class="token punctuation">(</span><span class="token plain">prevProps</span><span class="token punctuation">,</span><span class="token plain"> nextProps</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token plain">key</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">24</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">25</span><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> eventType </span><span class="token operator">=</span><span class="token plain"> name</span><span class="token punctuation">.</span><span class="token method function property-access">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">26</span><span class="token plain">      dom</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token plain">eventType</span><span class="token punctuation">,</span><span class="token plain"> prevProps</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">27</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">28</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">29</span><span class="token plain">  </span><span class="token comment">// 移除旧的属性</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">30</span><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">prevProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">31</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token plain">isProperty</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">32</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token function">isGone</span><span class="token punctuation">(</span><span class="token plain">prevProps</span><span class="token punctuation">,</span><span class="token plain"> nextProps</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">33</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">34</span><span class="token plain">      dom</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">35</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">36</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">37</span><span class="token plain">  </span><span class="token comment">// 添加或者更新属性</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">38</span><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">nextProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">39</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token plain">isProperty</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">40</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token function">isNew</span><span class="token punctuation">(</span><span class="token plain">prevProps</span><span class="token punctuation">,</span><span class="token plain"> nextProps</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">41</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">42</span><span class="token plain">      </span><span class="token comment">// React 规定 style 内联样式是驼峰命名的对象，</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">43</span><span class="token plain">      </span><span class="token comment">// 根据规范给 style 每个属性单独赋值</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">44</span><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">name </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;style&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">45</span><span class="token plain">        </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">entries</span><span class="token punctuation">(</span><span class="token plain">nextProps</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter punctuation">[</span><span class="token parameter">key</span><span class="token parameter punctuation">,</span><span class="token parameter"> value</span><span class="token parameter punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">46</span><span class="token plain">          dom</span><span class="token punctuation">.</span><span class="token property-access">style</span><span class="token punctuation">[</span><span class="token plain">key</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> value</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">47</span><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">48</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">49</span><span class="token plain">        dom</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> nextProps</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">50</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">51</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">52</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">53</span><span class="token plain">  </span><span class="token comment">// 添加新的事件处理函数</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">54</span><span class="token plain">  </span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token plain">nextProps</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">55</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token plain">isEvent</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">56</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token function">isNew</span><span class="token punctuation">(</span><span class="token plain">prevProps</span><span class="token punctuation">,</span><span class="token plain"> nextProps</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">57</span><span class="token plain">    </span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">58</span><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> eventType </span><span class="token operator">=</span><span class="token plain"> name</span><span class="token punctuation">.</span><span class="token method function property-access">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">59</span><span class="token plain">      dom</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain">eventType</span><span class="token punctuation">,</span><span class="token plain"> nextProps</span><span class="token punctuation">[</span><span class="token plain">name</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">60</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">61</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">62</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">63</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">64</span><span class="token plain">  deletions</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token plain">commitWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">65</span><span class="token plain">  </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">wipRoot</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">66</span><span class="token plain">  currentRoot </span><span class="token operator">=</span><span class="token plain"> wipRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">67</span><span class="token plain">  wipRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">68</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">69</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">70</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">71</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">72</span><span class="token plain">    </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">73</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">74</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> domParent </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">75</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;PLACEMENT&quot;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">76</span><span class="token plain">    domParent</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">77</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;UPDATE&quot;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">78</span><span class="token plain">    </span><span class="token function">updateDom</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">,</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">79</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;DELETION&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">80</span><span class="token plain">    domParent</span><span class="token punctuation">.</span><span class="token method function property-access">removeChild</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">81</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">82</span><span class="token plain">  </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">83</span><span class="token plain">  </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">84</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">85</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">86</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token parameter punctuation">,</span><span class="token parameter"> container</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">87</span><span class="token plain">  wipRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">88</span><span class="token plain">    dom</span><span class="token punctuation">:</span><span class="token plain"> container</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">89</span><span class="token plain">    props</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">90</span><span class="token plain">      children</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">element</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">91</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">92</span><span class="token plain">    alternate</span><span class="token punctuation">:</span><span class="token plain"> currentRoot</span></div><div class="token-line"><span class="number-line">93</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">94</span><span class="token plain">  deletions </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">95</span><span class="token plain">  nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> wipRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">96</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">97</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">98</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">99</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> currentRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">100</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> wipRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">101</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> deletions </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">102</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">103</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">104</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> shouldYield </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">105</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">shouldYield</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">106</span><span class="token plain">    nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">nextUnitOfWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">107</span><span class="token plain">    shouldYield </span><span class="token operator">=</span><span class="token plain"> deadline</span><span class="token punctuation">.</span><span class="token method function property-access">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">108</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">109</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">110</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">nextUnitOfWork </span><span class="token operator">&amp;&amp;</span><span class="token plain"> wipRoot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">111</span><span class="token plain">    </span><span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">112</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">113</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">114</span><span class="token plain">  </span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token plain">workLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">115</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">116</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">117</span><span class="token plain"></span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token plain">workLoop</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">118</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">119</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">120</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">121</span><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createDom</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">122</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">123</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">124</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> elements </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">125</span><span class="token plain">  </span><span class="token comment">// 原本添加 fiber 的逻辑挪到 reconcileChildren 函数</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">126</span><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> elements</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">127</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">128</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">129</span><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">130</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">131</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> nextFiber </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">132</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">133</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">134</span><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> nextFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">135</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">136</span><span class="token plain">    nextFiber </span><span class="token operator">=</span><span class="token plain"> nextFiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">137</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">138</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">139</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">140</span><span class="token plain"></span><span class="token comment">// 新增函数</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">141</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token parameter">wipFiber</span><span class="token parameter punctuation">,</span><span class="token parameter"> elements</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">142</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> index </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">143</span><span class="token plain">  </span><span class="token comment">// 上次渲染完成之后的 fiber 节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">144</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> oldFiber </span><span class="token operator">=</span><span class="token plain"> wipFiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> wipFiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">145</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> prevSibling </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">146</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">147</span><span class="token plain">  </span><span class="token comment">// 扁平化 props.children，处理函数组件的 children</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">148</span><span class="token plain">  elements </span><span class="token operator">=</span><span class="token plain"> elements</span><span class="token punctuation">.</span><span class="token method function property-access">flat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">149</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">150</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">&lt;</span><span class="token plain"> elements</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> oldFiber </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">151</span><span class="token plain">    </span><span class="token comment">// 本次需要渲染的子元素</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">152</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> elements</span><span class="token punctuation">[</span><span class="token plain">index</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">153</span><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> newFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">154</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">155</span><span class="token plain">    </span><span class="token comment">// 比较当前和上一次渲染的 type，即 DOM tag &#x27;div&#x27;，</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">156</span><span class="token plain">    </span><span class="token comment">// 暂不考虑自定义组件</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">157</span><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> sameType </span><span class="token operator">=</span><span class="token plain"> oldFiber </span><span class="token operator">&amp;&amp;</span><span class="token plain"> element </span><span class="token operator">&amp;&amp;</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> oldFiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">158</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">159</span><span class="token plain">    </span><span class="token comment">// 同类型节点，只需更新节点 props 即可</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">160</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">sameType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">161</span><span class="token plain">      newFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">162</span><span class="token plain">        type</span><span class="token punctuation">:</span><span class="token plain"> oldFiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">163</span><span class="token plain">        props</span><span class="token punctuation">:</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">164</span><span class="token plain">        dom</span><span class="token punctuation">:</span><span class="token plain"> oldFiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 复用旧节点的 DOM</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">165</span><span class="token plain">        parent</span><span class="token punctuation">:</span><span class="token plain"> wipFiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">166</span><span class="token plain">        alternate</span><span class="token punctuation">:</span><span class="token plain"> oldFiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">167</span><span class="token plain">        effectTag</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;UPDATE&quot;</span><span class="token plain"> </span><span class="token comment">// 新增属性，在提交/commit 阶段使用</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">168</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">169</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">170</span><span class="token plain">    </span><span class="token comment">// 不同类型节点且存在新的元素时，创建新的 DOM 节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">171</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">element </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">sameType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">172</span><span class="token plain">      newFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">173</span><span class="token plain">        type</span><span class="token punctuation">:</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">174</span><span class="token plain">        props</span><span class="token punctuation">:</span><span class="token plain"> element</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">175</span><span class="token plain">        dom</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">176</span><span class="token plain">        parent</span><span class="token punctuation">:</span><span class="token plain"> wipFiber</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">177</span><span class="token plain">        alternate</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">178</span><span class="token plain">        effectTag</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;PLACEMENT&quot;</span><span class="token plain"> </span><span class="token comment">// PLACEMENT 表示需要添加新的节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">179</span><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">180</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">181</span><span class="token plain">    </span><span class="token comment">// 不同类型节点，且存在旧的 fiber 节点时，</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">182</span><span class="token plain">    </span><span class="token comment">// 需要移除该节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">183</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">oldFiber </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">sameType</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">184</span><span class="token plain">      oldFiber</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&quot;DELETION&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">185</span><span class="token plain">      </span><span class="token comment">// 当最后提交 fiber 树到 DOM 时，我们是从 wipRoot 开始的，</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">186</span><span class="token plain">      </span><span class="token comment">// 此时没有上一次的 fiber，所以这里用一个数组来跟踪需要</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">187</span><span class="token plain">      </span><span class="token comment">// 删除的节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">188</span><span class="token plain">      deletions</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">oldFiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">189</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">190</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">191</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">oldFiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">192</span><span class="token plain">      </span><span class="token comment">// 同步更新下一个旧 fiber 节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">193</span><span class="token plain">      oldFiber </span><span class="token operator">=</span><span class="token plain"> oldFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">194</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">195</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">196</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">index </span><span class="token operator">===</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">197</span><span class="token plain">      wipFiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">198</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">199</span><span class="token plain">      prevSibling</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">200</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">201</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">202</span><span class="token plain">    prevSibling </span><span class="token operator">=</span><span class="token plain"> newFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">203</span><span class="token plain">    index</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">204</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">205</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><div class="evpml4g0 css-qjx5m"><p class="css-v0s5vi em5ola80">  注意：这个过程中 React 还用了 <code class="css-1udlz9w e1g3grwc0">key</code> 来检测数组元素变化了位置的情况，避免重复渲染以提高性能。简化起见，本文未实现。</p></div><p class="css-v0s5vi em5ola80">下面 CodeSandbox 代码用了个小技巧，重复执行 <code class="css-1udlz9w e1g3grwc0">render</code> 实现更新界面的效果，输入几个字试试看效果。</p><iframe src="https://codesandbox.io/embed/redact-1-dovfc?fontsize=14&amp;hidenavigation=1&amp;theme=dark" style="width:100%;max-width:800px;height:500px;border:0;border-radius:4px;overflow:hidden" title="redact-2" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe><hr class="css-xu77su e17vjet20"/><h2 id="VII: 函数组件" class="css-3a8jv7 e1deern01"><a href="#VII: 函数组件" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>VII: 函数组件</h2><p class="css-v0s5vi em5ola80">目前我们还只考虑了直接渲染 DOM 标签的情况，不支持组件，而组件是 React 是灵魂，下面我们来实现函数组件。</p><p class="css-v0s5vi em5ola80">以一个非常简单的组件代码为例。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-jsx" style="position:relative"><div class="css-gbt9ey eg6okne1">jsx</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token comment">/** @jsx Redact.createElement */</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">h1</span><span class="token tag punctuation">&gt;</span><span class="token plain">Hi </span><span class="token punctuation">{</span><span class="token plain">props</span><span class="token punctuation">.</span><span class="token plain">name</span><span class="token punctuation">}</span><span class="token tag punctuation">&lt;/</span><span class="token tag">h1</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain"></span><span class="token comment">// 等效 JS 代码 👇</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">App</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> Redact</span><span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">    </span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain">    </span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain">    </span><span class="token string">&quot;Hi &quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">    props</span><span class="token punctuation">.</span><span class="token plain">name</span></div><div class="token-line"><span class="number-line">13</span><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">14</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">16</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">App</span><span class="token tag"> </span><span class="token tag attr-name">name</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">foo</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">17</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> container </span><span class="token operator">=</span><span class="token plain"> document</span><span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">18</span><span class="token plain">Redact</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">,</span><span class="token plain"> container</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80">函数组件有2个不同点：</p><ul class="css-vb6hou eowy95v0"><li class="css-0">函数组件的 fiber 节点没有对应 DOM</li><li class="css-0">函数组件的 children 来自函数执行结果，而不是像标签元素一样直接从 props 获取，因为 children 不只是函数组件使用时包含的子孙节点，还需要组合组件本身的结构</li></ul><p class="css-v0s5vi em5ola80">注意以下代码省略了未改动部分。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">    </span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">  </span><span class="token comment">// 当 fiber 是函数组件时节点不存在 DOM，</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">  </span><span class="token comment">// 故需要遍历父节点以找到最近的有 DOM 的节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">8</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> domParentFiber </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">9</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">domParentFiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">10</span><span class="token plain">    domParentFiber </span><span class="token operator">=</span><span class="token plain"> domParentFiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">11</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> domParent </span><span class="token operator">=</span><span class="token plain"> domParentFiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">13</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;PLACEMENT&quot;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">14</span><span class="token plain">    domParent</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;UPDATE&quot;</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">16</span><span class="token plain">    </span><span class="token function">updateDom</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">,</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">17</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">effectTag</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&quot;DELETION&quot;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">18</span><span class="token plain">    </span><span class="token comment">// 直接移除 DOM 替换成 commitDeletion 函数</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">19</span><span class="token plain">    </span><span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> domParent</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">20</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">21</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">22</span><span class="token plain">  </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">23</span><span class="token plain">  </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">24</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">25</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">26</span><span class="token plain"></span><span class="token comment">// 新增函数，移除 DOM 节点</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">27</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"> domParent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">28</span><span class="token plain">  </span><span class="token comment">// 当 child 是函数组件时不存在 DOM，</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">29</span><span class="token plain">  </span><span class="token comment">// 故需要递归遍历子节点找到真正的 DOM</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">30</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">31</span><span class="token plain">    domParent</span><span class="token punctuation">.</span><span class="token method function property-access">removeChild</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">32</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">33</span><span class="token plain">    </span><span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">,</span><span class="token plain"> domParent</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">34</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">35</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">36</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">37</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">38</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> isFunctionComponent </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">39</span><span class="token plain">  </span><span class="token comment">// 原本逻辑挪到 updateHostComponent 函数</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">40</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isFunctionComponent</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">41</span><span class="token plain">    </span><span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">42</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">43</span><span class="token plain">    </span><span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">44</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">45</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">46</span><span class="token plain">    </span><span class="token keyword">return</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">47</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">48</span><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> nextFiber </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">49</span><span class="token plain">  </span><span class="token keyword">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">50</span><span class="token plain">    </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">51</span><span class="token plain">      </span><span class="token keyword">return</span><span class="token plain"> nextFiber</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">52</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">53</span><span class="token plain">    nextFiber </span><span class="token operator">=</span><span class="token plain"> nextFiber</span><span class="token punctuation">.</span><span class="token property-access">parent</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">54</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">55</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">56</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">57</span><span class="token plain"></span><span class="token comment">// 新增函数，处理函数组件</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">58</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">59</span><span class="token plain">  </span><span class="token comment">// 执行函数组件得到 children</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">60</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> children </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token method function property-access">type</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">61</span><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> children</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">62</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">63</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">64</span><span class="token plain"></span><span class="token comment">// 新增函数，处理原生标签组件</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">65</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">66</span><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">67</span><span class="token plain">    fiber</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createDom</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">68</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">69</span><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line highlight-line"><span class="number-line">70</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><hr class="css-xu77su e17vjet20"/><h2 id="VIII: 函数组件 Hooks" class="css-3a8jv7 e1deern01"><a href="#VIII: 函数组件 Hooks" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>VIII: 函数组件 Hooks</h2><p class="css-v0s5vi em5ola80">支持了函数组件，还需要支持组件状态 / state 才能实现刷新界面。</p><p class="css-v0s5vi em5ola80">我们的示例也跟着更新，用 hooks 实现经典的 counter，点击计数器加1。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-jsx" style="position:relative"><div class="css-gbt9ey eg6okne1">jsx</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token comment">/** @jsx Redact.createElement */</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">Counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">state</span><span class="token punctuation">,</span><span class="token plain"> setState</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> Redact</span><span class="token punctuation">.</span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">h1</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript operator">=&gt;</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript function">setState</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript parameter">c</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript operator">=&gt;</span><span class="token tag script language-javascript"> c </span><span class="token tag script language-javascript operator">+</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript number">1</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain">      Count</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">state</span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">h1</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag class-name">Counter</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> container </span><span class="token operator">=</span><span class="token plain"> document</span><span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">Redact</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">,</span><span class="token plain"> container</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p class="css-v0s5vi em5ola80">注意以下代码省略了未变化部分。</p><div class="css-xqe627 eg6okne0"><pre class="prism-code language-js" style="position:relative"><div class="css-gbt9ey eg6okne1">js</div><button data-a11y="false" class="css-1hl1i47 eg6okne2">复制 <svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#6f7177"></path></svg></button><div class="token-line"><span class="number-line">1</span><span class="token comment">// 新增变量，渲染进行中的 fiber 节点</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">2</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> wipFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">3</span><span class="token plain"></span><span class="token comment">// 新增变量，当前 hook 的索引，以支持同一个函数组件多次调用 useState</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">4</span><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> hookIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">5</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">6</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token parameter">fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">7</span><span class="token plain">  </span><span class="token comment">// 更新进行中的 fiber 节点</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">8</span><span class="token plain">  wipFiber </span><span class="token operator">=</span><span class="token plain"> fiber</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">9</span><span class="token plain">  </span><span class="token comment">// 重置 hook 索引</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">10</span><span class="token plain">  hookIndex </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">11</span><span class="token plain">  </span><span class="token comment">// 新增 hooks 数组以支持同一个组件多次调用 useState</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">12</span><span class="token plain">  wipFiber</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">13</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> children </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token method function property-access">type</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">14</span><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> children</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">15</span><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">16</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">17</span><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initial</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">18</span><span class="token plain">  </span><span class="token comment">// alternate 保存了上一次渲染的 fiber 节点</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">19</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> oldHook </span><span class="token operator">=</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">20</span><span class="token plain">    wipFiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">21</span><span class="token plain">    wipFiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">22</span><span class="token plain">    wipFiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">[</span><span class="token plain">hookIndex</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">23</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">24</span><span class="token plain">    </span><span class="token comment">// 第一次渲染使用入参，第二次渲染复用前一次的状态</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">25</span><span class="token plain">    state</span><span class="token punctuation">:</span><span class="token plain"> oldHook </span><span class="token operator">?</span><span class="token plain"> oldHook</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> initial</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">26</span><span class="token plain">    </span><span class="token comment">// 保存每次 setState 入参的队列</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">27</span><span class="token plain">    queue</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">28</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">29</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">30</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> actions </span><span class="token operator">=</span><span class="token plain"> oldHook </span><span class="token operator">?</span><span class="token plain"> oldHook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">31</span><span class="token plain">  actions</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">32</span><span class="token plain">    </span><span class="token comment">// 根据调用 setState 顺序从前往后生成最新的 state</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">33</span><span class="token plain">    hook</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> action </span><span class="token keyword">instanceof</span><span class="token plain"> </span><span class="token class-name">Function</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token function">action</span><span class="token punctuation">(</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">:</span><span class="token plain"> action</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">34</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">35</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">36</span><span class="token plain">  </span><span class="token comment">// setState 函数用于更新 state，入参 action</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">37</span><span class="token plain">  </span><span class="token comment">// 是新的 state 值或函数返回新的 state</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">38</span><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">setState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token parameter">action</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">39</span><span class="token plain">    hook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">action</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">40</span><span class="token plain">    </span><span class="token comment">// 下面这部分代码和 render 函数很像，</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">41</span><span class="token plain">    </span><span class="token comment">// 设置新的 wipRoot 和 nextUnitOfWork</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">42</span><span class="token plain">    </span><span class="token comment">// 浏览器空闲时即开始重新渲染。</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">43</span><span class="token plain">    wipRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">44</span><span class="token plain">      dom</span><span class="token punctuation">:</span><span class="token plain"> currentRoot</span><span class="token punctuation">.</span><span class="token property-access">dom</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">45</span><span class="token plain">      props</span><span class="token punctuation">:</span><span class="token plain"> currentRoot</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">46</span><span class="token plain">      alternate</span><span class="token punctuation">:</span><span class="token plain"> currentRoot</span></div><div class="token-line"><span class="number-line">47</span><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">48</span><span class="token plain">    nextUnitOfWork </span><span class="token operator">=</span><span class="token plain"> wipRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">49</span><span class="token plain">    deletions </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">50</span><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">51</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">52</span><span class="token plain">  </span><span class="token comment">// 保存本次 hook</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">53</span><span class="token plain">  wipFiber</span><span class="token punctuation">.</span><span class="token property-access">hooks</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">hook</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">54</span><span class="token plain">  hookIndex</span><span class="token operator">++</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">55</span><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">,</span><span class="token plain"> setState</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="number-line">56</span><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p class="css-v0s5vi em5ola80">完整 CodeSandbox 代码如下，点击 Count 试试：</p><iframe src="https://codesandbox.io/embed/redact-2-rx063?fontsize=14&amp;hidenavigation=1&amp;theme=dark" style="width:100%;max-width:800px;height:500px;border:0;border-radius:4px;overflow:hidden" title="redact-3" allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb" sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"></iframe><hr class="css-xu77su e17vjet20"/><h2 id="结语" class="css-3a8jv7 e1deern01"><a href="#结语" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>结语</h2><p class="css-v0s5vi em5ola80">除了帮助读者理解 React 核心工作原理外，本文很多变量都和 React 官方代码保持一致，比如，读者在 React 应用的任何函数组件里断点，再打开调试工作能看到下面这样的调用栈：</p><ul class="css-vb6hou eowy95v0"><li class="css-0">updateFunctionComponent</li><li class="css-0">performUnitOfWork</li><li class="css-0">workLoop</li></ul><p class="css-v0s5vi em5ola80"><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:746px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:73.72654155495978%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/svg+xml,%3csvg%20xmlns=\&#x27;http://www.w3.org/2000/svg\&#x27;%20width=\&#x27;400\&#x27;%20height=\&#x27;295\&#x27;%3e%3cpath%20d=\&#x27;M0%20148v147h401V0H0v148M176%207c-4%205-4%206-4%203%201-2%201-2-2-2-4%200-4%200-4%205%200%204%201%205%203%203h1l-1%202v3l3-3%202-2%204%201c7%200%209-6%203-8-1-1-2-2-1-4%200-3%200-3-4%202m24%200c-4%205-1%2013%206%2013%206%200%2010-9%205-13-3-3-8-2-11%200m-74%2029l-2%203-2%202-2-1c-2-3-5-2-6%201l-1%201v-2c0-2%200-2-2-2-3%200-4%203-1%205v1l-2%201h8l4%201c1-1%201-1-1-2l-2-1h2c2%200%203%201%203%202l4%201c2%200%203-1%203-5s-1-8-3-5M22%2041c0%205%200%205%203%205l4-2c2-2%202-2%203%200l4%202c3%200%203-2%200-2l-2-1h2l2-2c0-3-4-4-6-2-1%202-1%202-2%200-2-2-3-3-5-3-3%200-3%200-3%205m64%202l1%205%201-1%202-1%202-2%201%201c2%202%207%201%206-1%200-2%200-2%202%200l4%202c2%200%202%200%202-4%200-5-2-5-3%200l-1%203v-4c0-3-2-4-3-1h-1c-2-3-5-2-5%200v2l-2-2c-4-4-6-3-6%203\&#x27;%20fill=\&#x27;%23d3d3d3\&#x27;%20fill-rule=\&#x27;evenodd\&#x27;/%3e%3c/svg%3e&#x27;);background-size:cover;display:block"></span>
  <img tabindex="0" class="Image__Zoom" alt="call stack" title="call stack" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/121efb5a689f2e6588ff621787546ead/4b0c0/stack.png" srcSet="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/121efb5a689f2e6588ff621787546ead/4b0c0/stack.png 746w" sizes="(max-width: 746px) 100vw, 746px" style="cursor:zoom-in;display:block;margin:0 auto;width:100%" loading="lazy"/>
    </span></p><p class="css-v0s5vi em5ola80">注意本文是教学性质的，还缺少很多 React 的功能和性能优化。比如：在这些事情上 React 的表现和 Redact 不同。</p><ul class="css-vb6hou eowy95v0"><li class="css-0">Redact 在渲染阶段遍历了整棵树，而 React 用了一些启发性算法，可以直接跳过某些没有变化的子树，以提高性能。（比如 React 数组元素推荐带 key，可以跳过无需更新的节点，参考<a rel="noopener noreferrer" href="https://zh-hans.reactjs.org/docs/reconciliation.html#keys" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">官方文档</span></a>）</li><li class="css-0">Redact 在 commit 阶段遍历整棵树， React 用了一个链表保存变化了的 fiber，减少了很多不必要遍历操作。</li><li class="css-0">Redact 每次创建新的 fiber 树时都是直接创建 fiber 对象节点，而 React 会复用上一个 fiber 对象，以节省创建对象的性能消耗。</li><li class="css-0">Redact 如果在渲染阶段收到新的更新会直接丢弃已渲染的树，再从头开始渲染。而 React 会用时间戳标记每次更新，以决定更新的优先级。</li><li class="css-0">源码还有很多优化等待读者去发现。。。</li></ul><hr class="css-xu77su e17vjet20"/><h2 id="参考" class="css-3a8jv7 e1deern01"><a href="#参考" aria-hidden="true" tabindex="-1" class="css-1m33aeh ewsugw10"><svg fill="none" height="24" width="24" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a>参考</h2><p class="css-v0s5vi em5ola80">征得原作者同意，本文参考了 <a rel="noopener noreferrer" href="https://pomb.us/build-your-own-react/" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">build-your-own-react</span></a> 部分内容，推荐英文水平不错读者直接在桌面端阅读原文以获得最佳阅读体验。</p><ul class="css-vb6hou eowy95v0"><li class="css-0"><a rel="noopener noreferrer" href="https://pomb.us/build-your-own-react/" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">build your own react</span></a></li><li class="css-0"><a rel="noopener noreferrer" href="https://jasonformat.com/wtf-is-jsx/" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">wtf is jsx</span></a></li><li class="css-0"><a rel="noopener noreferrer" href="https://medium.com/@sweetpalma/gooact-react-in-160-lines-of-javascript-44e0742ad60f" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">gooact react in 160 lines of javascript</span></a></li></ul><style data-emotion-css="1duzlke animation-1xhp7f5">.css-1duzlke{position:absolute;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;z-index:1;width:255px;height:46px;padding:7px 11px 7px 19px;color:var(--theme-ui-colors-grey,#73737D);background:#000;border-radius:5px;font-size:18px;font-weight:600;-webkit-transition:left 75ms ease-out,right 75ms ease-out,background 200ms;transition:left 75ms ease-out,right 75ms ease-out,background 200ms;-webkit-animation:animation-1xhp7f5 200ms forwards;animation:animation-1xhp7f5 200ms forwards;}.css-1duzlke::after{content:'';position:absolute;left:0;right:0;margin:0 auto;bottom:-8px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid #000;-webkit-transition:border-color 200ms;transition:border-color 200ms;}.css-1duzlke svg path{fill:#fff;}@-webkit-keyframes animation-1xhp7f5{0%{-webkit-transform:matrix(.97,0,0,1,0,12);-ms-transform:matrix(.97,0,0,1,0,12);transform:matrix(.97,0,0,1,0,12);opacity:0;}20%{-webkit-transform:matrix(.99,0,0,1,0,2);-ms-transform:matrix(.99,0,0,1,0,2);transform:matrix(.99,0,0,1,0,2);opacity:.7;}40%{-webkit-transform:matrix(1,0,0,1,0,-1);-ms-transform:matrix(1,0,0,1,0,-1);transform:matrix(1,0,0,1,0,-1);opacity:1;}70%{-webkit-transform:matrix(1,0,0,1,0,0);-ms-transform:matrix(1,0,0,1,0,0);transform:matrix(1,0,0,1,0,0);opacity:1;}100%{-webkit-transform:matrix(1,0,0,1,0,0);-ms-transform:matrix(1,0,0,1,0,0);transform:matrix(1,0,0,1,0,0);opacity:1;}}@keyframes animation-1xhp7f5{0%{-webkit-transform:matrix(.97,0,0,1,0,12);-ms-transform:matrix(.97,0,0,1,0,12);transform:matrix(.97,0,0,1,0,12);opacity:0;}20%{-webkit-transform:matrix(.99,0,0,1,0,2);-ms-transform:matrix(.99,0,0,1,0,2);transform:matrix(.99,0,0,1,0,2);opacity:.7;}40%{-webkit-transform:matrix(1,0,0,1,0,-1);-ms-transform:matrix(1,0,0,1,0,-1);transform:matrix(1,0,0,1,0,-1);opacity:1;}70%{-webkit-transform:matrix(1,0,0,1,0,0);-ms-transform:matrix(1,0,0,1,0,0);transform:matrix(1,0,0,1,0,0);opacity:1;}100%{-webkit-transform:matrix(1,0,0,1,0,0);-ms-transform:matrix(1,0,0,1,0,0);transform:matrix(1,0,0,1,0,0);opacity:1;}}</style><div style="position:absolute;left:0px;top:0px;display:none;pointer-events:none" class="css-1duzlke e1w39vvk0"><style data-emotion-css="gugfy2">.css-gugfy2{margin-right:11px;}</style><span class="css-gugfy2 e1w39vvk1">分享到：</span><style data-emotion-css="pd22cz">.css-pd22cz{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px 11px;cursor:pointer;}</style><a class="css-pd22cz e1w39vvk3"><style data-emotion-css="18l3o48">.css-18l3o48{width:0px;height:0px;visibility:hidden;opacity:0;}</style><div class="css-18l3o48 e1w39vvk2">Share the selected text</div><svg width="18px" height="15px" viewBox="0 0 16 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.0658 2.34438C14.7013 1.96349 15.1892 1.3604 15.419 0.641811C14.8244 0.994439 14.1658 1.25056 13.4648 1.3886C12.9034 0.7905 12.1036 0.416748 11.2185 0.416748C9.51888 0.416748 8.14096 1.79461 8.14096 3.49411C8.14096 3.7353 8.16822 3.97019 8.22068 4.19542C5.66301 4.06708 3.39543 2.84191 1.8776 0.980064C1.6127 1.43458 1.46094 1.96322 1.46094 2.52719C1.46094 3.59485 2.00428 4.5368 2.83003 5.08865C2.32553 5.07268 1.85104 4.93425 1.43608 4.70376C1.43586 4.71659 1.43586 4.72949 1.43586 4.74244C1.43586 6.23349 2.49666 7.47732 3.90448 7.75999C3.64622 7.83033 3.37436 7.86792 3.09366 7.86792C2.89537 7.86792 2.70257 7.84866 2.51471 7.81272C2.90629 9.03537 4.0428 9.92509 5.38945 9.94994C4.33623 10.7753 3.00928 11.2673 1.56749 11.2673C1.31911 11.2673 1.07413 11.2528 0.833374 11.2243C2.19527 12.0975 3.81291 12.6069 5.55081 12.6069C11.2113 12.6069 14.3067 7.91763 14.3067 3.85096C14.3067 3.71753 14.3037 3.5848 14.2978 3.45285C14.899 3.01896 15.4208 2.47694 15.8334 1.8598C15.2815 2.10456 14.6884 2.26998 14.0658 2.34438Z" fill="white"></path></svg></a><a class="css-pd22cz e1w39vvk3"><div class="css-18l3o48 e1w39vvk2">Share the selected text</div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20px" height="20px" fill="#000000"><g><path fill="white" d="M 16.28125 3.8125 C 16.054688 3.828125 15.816406 3.859375 15.59375 3.90625 C 15.179688 3.996094 14.910156 4.402344 15 4.8125 C 15.085938 5.226563 15.492188 5.496094 15.90625 5.40625 C 17.179688 5.136719 18.566406 5.53125 19.5 6.5625 C 20.433594 7.597656 20.679688 9.011719 20.28125 10.25 C 20.152344 10.652344 20.378906 11.089844 20.78125 11.21875 C 21.183594 11.347656 21.617188 11.121094 21.75 10.71875 C 22.3125 8.976563 21.96875 7.015625 20.65625 5.5625 C 19.671875 4.46875 18.296875 3.875 16.9375 3.8125 C 16.710938 3.800781 16.507813 3.796875 16.28125 3.8125 Z M 10.0625 6.09375 C 8.667969 6.242188 6.699219 7.332031 4.96875 9.0625 C 3.082031 10.949219 2 12.957031 2 14.6875 C 2 17.996094 6.226563 20 10.375 20 C 15.8125 20 19.4375 16.820313 19.4375 14.3125 C 19.4375 12.796875 18.179688 11.949219 17.03125 11.59375 C 16.75 11.507813 16.539063 11.464844 16.6875 11.09375 C 17.007813 10.289063 17.066406 9.589844 16.71875 9.09375 C 16.070313 8.164063 14.253906 8.210938 12.21875 9.0625 C 12.21875 9.0625 11.585938 9.351563 11.75 8.84375 C 12.0625 7.835938 12.019531 6.988281 11.53125 6.5 C 11.1875 6.152344 10.695313 6.027344 10.0625 6.09375 Z M 16.8125 6.5 C 16.589844 6.488281 16.375 6.515625 16.15625 6.5625 C 15.800781 6.636719 15.578125 7.019531 15.65625 7.375 C 15.734375 7.730469 16.082031 7.953125 16.4375 7.875 C 16.863281 7.785156 17.34375 7.902344 17.65625 8.25 C 17.96875 8.597656 18.042969 9.054688 17.90625 9.46875 C 17.792969 9.816406 17.964844 10.199219 18.3125 10.3125 C 18.660156 10.421875 19.046875 10.253906 19.15625 9.90625 C 19.429688 9.058594 19.265625 8.085938 18.625 7.375 C 18.144531 6.84375 17.476563 6.53125 16.8125 6.5 Z M 10.8125 10.90625 C 13.582031 11.003906 15.8125 12.378906 16 14.28125 C 16.214844 16.457031 13.71875 18.484375 10.40625 18.8125 C 7.09375 19.140625 4.214844 17.640625 4 15.46875 C 3.785156 13.292969 6.316406 11.265625 9.625 10.9375 C 10.039063 10.898438 10.417969 10.890625 10.8125 10.90625 Z M 8.9375 13 C 7.804688 13.101563 6.734375 13.75 6.25 14.6875 C 5.589844 15.964844 6.242188 17.378906 7.75 17.84375 C 9.308594 18.324219 11.140625 17.597656 11.78125 16.21875 C 12.410156 14.871094 11.605469 13.472656 10.0625 13.09375 C 9.691406 13 9.316406 12.964844 8.9375 13 Z M 8.21875 15.0625 C 8.351563 15.066406 8.472656 15.109375 8.59375 15.15625 C 9.082031 15.355469 9.234375 15.878906 8.9375 16.34375 C 8.632813 16.804688 7.988281 17.027344 7.5 16.8125 C 7.019531 16.601563 6.882813 16.074219 7.1875 15.625 C 7.414063 15.289063 7.824219 15.058594 8.21875 15.0625 Z "></path></g></svg></a><style data-emotion-css="1lnhvdd">.css-1lnhvdd{display:inline-block;height:17px;width:1px;position:relative;margin:0 8px;background:rgba(115,115,125,0.3);}</style><div class="css-1lnhvdd e1w39vvk5"></div><style data-emotion-css="15hjez6">.css-15hjez6{display:inline-block;padding:16px 11px;}</style><button aria-label="Copy selected text" class="css-15hjez6 e1w39vvk4"><svg width="15" height="19" viewBox="0 0 15 19" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.0475 0.905273H1.67197C0.812542 0.905273 0.109375 1.60844 0.109375 2.46787V13.406H1.67197V2.46787H11.0475V0.905273ZM13.3914 4.03046H4.79716C3.93773 4.03046 3.23456 4.73363 3.23456 5.59306V16.5312C3.23456 17.3906 3.93773 18.0938 4.79716 18.0938H13.3914C14.2509 18.0938 14.954 17.3906 14.954 16.5312V5.59306C14.954 4.73363 14.2509 4.03046 13.3914 4.03046ZM13.3914 16.5312H4.79716V5.59306H13.3914V16.5312Z" fill="#08080B"></path></svg></button></div><style data-emotion-css="1d1i3lp">.css-1d1i3lp{background:#ccc;height:1px;margin:0 auto;width:100%;max-width:680px;}</style><div class="css-1d1i3lp e1nfwq1l0"></div></div></article><div id="utterancContainer"></div><style data-emotion-css="a8wemg">.css-a8wemg{width:100%;max-width:1220px;margin:0 auto;padding:0 4rem;margin-bottom:2rem;}@media (max-width:66.875em){.css-a8wemg{max-width:850px;}}@media (max-width:45.9375em){.css-a8wemg{padding:0 2rem;max-width:527px;}}@media (max-width:33.75em){.css-a8wemg{max-width:100%;}}</style><section class="css-a8wemg ea3ehcj0"><a rel="noopener noreferrer" href="https://github.com/devrsi0n/blog/edit/master/content/posts/2020/02/create-react-from-scratch/index.mdx" class="css-14mpdsk e1cfml80"><span class="css-uux7qa e1cfml81">在 GitHub 上编辑此文</span></a></section><style data-emotion-css="npfbur">.css-npfbur{width:100%;max-width:1220px;margin:0 auto;padding:0 4rem;display:block;}@media (max-width:66.875em){.css-npfbur{max-width:850px;}}@media (max-width:45.9375em){.css-npfbur{padding:0 2rem;max-width:527px;}}@media (max-width:33.75em){.css-npfbur{max-width:100%;}}</style><section class="css-npfbur ea3ehcj3"><style data-emotion-css="1vgsxfa">.css-1vgsxfa{position:relative;opacity:0.25;margin-bottom:100px;font-weight:400;color:var(--theme-ui-colors-primary,#000);}@media (max-width:45.9375em){.css-1vgsxfa{margin-bottom:60px;}}.css-1vgsxfa::after{content:'';position:absolute;background:var(--theme-ui-colors-grey,#73737D);width:79.82456140350878%;height:1px;right:0;top:11px;}@media (max-width:45.9375em){.css-1vgsxfa::after{width:52.63157894736842%;}}@media (max-width:33.75em){.css-1vgsxfa::after{width:35.08771929824561%;}}@media (max-width:23.5em){.css-1vgsxfa::after{width:90px;}}</style><h3 class="css-1vgsxfa ea3ehcj4">其他文章</h3><style data-emotion-css="80jzpj">.css-80jzpj{position:relative;display:grid;grid-template-columns:1fr 457px;grid-template-rows:2;-webkit-column-gap:30px;column-gap:30px;margin:0 auto;max-width:100%;}@media (max-width:66.875em){.css-80jzpj{grid-template-columns:1fr 1fr;}}@media (max-width:45.9375em){.css-80jzpj{grid-template-columns:1fr;}}</style><div class="css-80jzpj efc6uiy0"><style data-emotion-css="1n3bl4h">.css-1n3bl4h{position:relative;display:block;width:100%;height:100%;top:0;left:0;z-index:1;-webkit-transition:-webkit-transform 0.33s var(--ease-out-quart);-webkit-transition:transform 0.33s var(--ease-out-quart);transition:transform 0.33s var(--ease-out-quart);-webkit-tap-highlight-color:rgba(255,255,255,0);}.css-1n3bl4h:hover .efc6uiy1{-webkit-transform:translateY(-1px);-ms-transform:translateY(-1px);transform:translateY(-1px);box-shadow:0 50px 80px -20px rgba(0,0,0,0.27),0 30px 50px -30px rgba(0,0,0,0.3);}.css-1n3bl4h:hover h2,.css-1n3bl4h:focus h2{color:var(--theme-ui-colors-accent,#6166DC);}.css-1n3bl4h[data-a11y='true']:focus::after{content:'';position:absolute;left:-2%;top:-2%;width:104%;height:104%;border:3px solid var(--theme-ui-colors-accent,#6166DC);background:rgba(255,255,255,0.01);}@media (max-width:33.75em){.css-1n3bl4h:hover .efc6uiy1{-webkit-transform:none;-ms-transform:none;transform:none;box-shadow:initial;}.css-1n3bl4h:active{-webkit-transform:scale(0.97) translateY(3px);-ms-transform:scale(0.97) translateY(3px);transform:scale(0.97) translateY(3px);}}</style><a data-a11y="false" narrow="false" class="css-1n3bl4h efc6uiy6" href="/articles/github-actions-ci-failed-with-electron"><style data-emotion-css="1g2qwvh">.css-1g2qwvh{position:relative;}@media (max-width:540px){.css-1g2qwvh{box-shadow:0px 20px 40px rgba(0,0,0,0.2);border-bottom-right-radius:5px;border-bottom-left-radius:5px;background:var(--theme-ui-colors-card,#fff);}}</style><div class="css-1g2qwvh efc6uiy2"><style data-emotion-css="f56zxy">.css-f56zxy{position:relative;height:280px;box-shadow:0 30px 60px -10px rgba(0,0,0,0.3),0 18px 36px -18px rgba(0,0,0,0.33);margin-bottom:30px;-webkit-transition:-webkit-transform 0.3s var(--ease-out-quad),box-shadow 0.3s var(--ease-out-quad);-webkit-transition:transform 0.3s var(--ease-out-quad),box-shadow 0.3s var(--ease-out-quad);transition:transform 0.3s var(--ease-out-quad),box-shadow 0.3s var(--ease-out-quad);}.css-f56zxy > div{height:100%;}@media (max-width:45.9375em){.css-f56zxy{height:220px;margin-bottom:35px;}}@media (max-width:33.75em){.css-f56zxy{height:200px;margin-bottom:0;box-shadow:none;overflow:hidden;border-top-right-radius:5px;border-top-left-radius:5px;}}</style><div class="css-f56zxy efc6uiy1"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:52.760736196319016%"></div><img aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20width=&#x27;400&#x27;%20height=&#x27;210&#x27;%3e%3cpath%20d=&#x27;M184%2054c-8%201-12%203-16%207-4%206-5%2012-5%2033%200%2017%201%2019%203%2023%205%209%2013%2011%2037%2011%2022-1%2026-3%2032-12%202-4%203-38%201-46-1-6-8-14-14-15-5-1-31-2-38-1m-2%2018l-2%204c-1%203%201%209%204%209%202%201%202%202%202%208%200%207%202%2012%205%2012l3%203c4%204%2011%202%2011-4%200-5-7-7-11-3-3%205-6%202-6-6%200-5%200-5%202-4l5%204c3%203%206%203%208%200l4-3%203%203c2%202%205%203%208%200%204-2%202-10-3-10-3%200-6%202-6%204s-3%201-6-1l-4-3-4%203c-3%202-4%203-6%200-1-1-1-1%202-2%204-1%205-4%205-8%200-7-9-11-14-6m3%200c-2%201-4%204-4%206%200%203%205%207%207%207%203%200%207-4%207-7%200-4-5-8-10-6m176%202c-10%205-9%2012%201%2012s18-7%2014-12c-3-3-9-3-15%200M95%20111c-9%203-12%2010-6%2012%205%202%2014-1%2018-5%203-6-4-10-12-7&#x27;%20fill=&#x27;%23d3d3d3&#x27;%20fill-rule=&#x27;evenodd&#x27;/%3e%3c/svg%3e" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source type='image/webp' srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/5c39c/hero.webp 163w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/a891a/hero.webp 327w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/82e8a/hero.webp 653w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/4f963/hero.webp 980w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/9542f/hero.webp 1200w" sizes="(max-width: 653px) 100vw, 653px" /><source srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/76bd0/hero.png 163w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/12811/hero.png 327w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/64dde/hero.png 653w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/a6fa7/hero.png 980w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/ab97f/hero.png 1200w" sizes="(max-width: 653px) 100vw, 653px" /><img loading="lazy" sizes="(max-width: 653px) 100vw, 653px" srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/76bd0/hero.png 163w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/12811/hero.png 327w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/64dde/hero.png 653w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/a6fa7/hero.png 980w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/ab97f/hero.png 1200w" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/059fe3bfec635ff15f251e5f407ffa51/64dde/hero.png" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div><style data-emotion-css="actc9m">.css-actc9m{font-size:24px;line-height:1.45;word-break:keep-all;font-weight:bold;color:var(--theme-ui-colors-primary,#000);font-family:Georgia,"Noto Serif CJK SC","Source Han Serif SC","Source Han Serif CN","Songti SC","SimSun","STSong","AR PL Sungti",serif;font-size:22px;line-height:1.4;margin-bottom:10px;color:var(--theme-ui-colors-primary,#000);font-family:Georgia,"Noto Serif CJK SC","Source Han Serif SC","Source Han Serif CN","Songti SC","SimSun","STSong","AR PL Sungti",serif;-webkit-transition:color 0.3s ease-in-out;transition:color 0.3s ease-in-out;text-overflow:ellipsis;overflow-wrap:normal;-webkit-line-clamp:2;-webkit-box-orient:vertical;display:-webkit-box;white-space:normal;overflow:hidden;}@media (max-width:45.9375em){.css-actc9m{font-size:22px;}}@media (max-width:33.75em){.css-actc9m{font-size:20px;}}@media (max-width:33.75em){.css-actc9m{-webkit-line-clamp:3;}}@media (max-width:45.9375em){.css-actc9m{margin-bottom:15px;}}@media (max-width:33.75em){.css-actc9m{padding:30px 20px 0;margin-bottom:10px;-webkit-line-clamp:3;}}</style><h3 class="css-actc9m efc6uiy3">使用 Electron 时 GitHub Actions 执行失败</h3><style data-emotion-css="1rec7sy">.css-1rec7sy{text-overflow:ellipsis;overflow-wrap:normal;-webkit-line-clamp:2;-webkit-box-orient:vertical;display:-webkit-box;white-space:normal;overflow:hidden;font-size:16px;margin-bottom:10px;color:var(--theme-ui-colors-grey,#73737D);display:box;max-width:515px;}@media (max-width:33.75em){.css-1rec7sy{-webkit-line-clamp:3;}}@media (max-width:66.875em){.css-1rec7sy{display:-webkit-box;}}@media (max-width:45.9375em){.css-1rec7sy{margin-bottom:15px;}}@media (max-width:33.75em){.css-1rec7sy{max-width:100%;padding:0 20px;margin-bottom:20px;-webkit-line-clamp:3;}}</style><p class="css-1rec7sy efc6uiy4">GitHub Actions  是 GitHub 官方近期推出的免费自动化软件开发流程服务，可用来替代 circleci/travis 这类第三方服务，而且因为榜上微软这个金主，GitHub 的官方服务构建速度和易用度都挺不错的。比如下面著名 iOS 大神  onevcat…</p><style data-emotion-css="118hiy6">.css-118hiy6{font-weight:600;font-size:16px;color:var(--theme-ui-colors-grey,#73737D);opacity:0.33;}@media (max-width:33.75em){.css-118hiy6{max-width:100%;padding:0 20px 30px;}}</style><div class="css-118hiy6 efc6uiy5">2019-11-10</div></div></a><style data-emotion-css="1h28hvc">.css-1h28hvc{position:relative;display:block;width:100%;height:100%;top:0;left:0;z-index:1;-webkit-transition:-webkit-transform 0.33s var(--ease-out-quart);-webkit-transition:transform 0.33s var(--ease-out-quart);transition:transform 0.33s var(--ease-out-quart);-webkit-tap-highlight-color:rgba(255,255,255,0);}.css-1h28hvc:hover .efc6uiy1{-webkit-transform:translateY(-1px);-ms-transform:translateY(-1px);transform:translateY(-1px);box-shadow:0 50px 80px -20px rgba(0,0,0,0.27),0 30px 50px -30px rgba(0,0,0,0.3);}.css-1h28hvc:hover h2,.css-1h28hvc:focus h2{color:var(--theme-ui-colors-accent,#6166DC);}.css-1h28hvc[data-a11y='true']:focus::after{content:'';position:absolute;left:-2%;top:-2%;width:104%;height:104%;border:3px solid var(--theme-ui-colors-accent,#6166DC);background:rgba(255,255,255,0.01);}@media (max-width:45.9375em){.css-1h28hvc{display:none;}}@media (max-width:33.75em){.css-1h28hvc:hover .efc6uiy1{-webkit-transform:none;-ms-transform:none;transform:none;box-shadow:initial;}.css-1h28hvc:active{-webkit-transform:scale(0.97) translateY(3px);-ms-transform:scale(0.97) translateY(3px);transform:scale(0.97) translateY(3px);}}</style><a data-a11y="false" narrow="true" class="css-1h28hvc efc6uiy6" href="/articles/eslint-typescript-import-unsolve"><div class="css-1g2qwvh efc6uiy2"><div class="css-f56zxy efc6uiy1"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div aria-hidden="true" style="width:100%;padding-bottom:66.66666666666667%"></div><img aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%20width=&#x27;400&#x27;%20height=&#x27;267&#x27;%3e%3cpath%20d=&#x27;M398%207l-3%202c-1-1-1-1-1%201%201%201%201%201%200%200v1l1%202-2-1-1-1-1-1h-2c-2%201-1%202%201%204l2%203-3%201-4%201-2-1c0%201%203%204%205%204h1c1%201%202%202%204%201%203%200%205%202%203%204-3%201-14%201-16-1-1-2-1-2-1%200v3h-1l-2%202-2%201h2c3%200%204%202%201%202-2%200-2%200-1%202h2c2-2%203-1%203%201v2l1%203h-2c-1-3-3-3-3-1s0%202-1%201-1-1-1%201%200%203%202%203%202%200%202%202v1l-1%202-4%202-1%203c0%203%200%203-4%202l-6-1c-4-2-4%202%200%205%205%204%205%205%201%205-5%200-6%201-4%203h2c1%200%204%203%204%205h-5l-3-1c-1%201-2%200-2-1h-7l-12-3c-10%200-14-1-15-2l1-1c2%200%201-3-1-3-1%200-2%200-1-1v-2h-2l-2-2-3-2v1c2%202%204%206%203%207l3%201c1%200%202%200%201%201h-5a8128%208128%200%2001-21-1l-7%202-5%201c-4-1-4-1-3%201l4%201%202%201%203%201h10l7%202h-7c-8-1-8%201%200%202l11%201%2016%201a155%20155%200%200131%204c4-1%202-2-5-3h-9a224%20224%200%2000-28-5l-4-1c-3-2%2017%200%2021%202h3l6%201c3%201%207%202%208%201l2%201h3c1-1%202%200%204%201l4%201%203%201-1%201-2%201h-4l-2%201c0%201%203%202%206%201l1%201c-1%201-1%201%201%201%203%200%203%200%202%202l-2%201-8-1-5%201h-4l4%201c3%200%203%200%202%201v1l2%201-1%201-5-1-6-1-3-2-4-1-3%201h-2c0%201-1%201-1-1-1-2-3-3-3%200l-1-1-2-2v5l-1-3c-1-2-5-4-6-2l-3-2-3-1-3-2h-2c-1%201-1%201-1-1l-2-2-3-1-7-1c0%201%204%203%205%202l1%201%201%202c0%201-1%202-5%202l-6-1h-7v-1c1-2%201-2-3-3h-5l-2-1c-3-2-24-6-24-4l-1%201-2%201h-2l-2-1-2-1-3-1-3-1-7-1-7-2-3-1-3-1-3%201h-3l-9-2-8-2h-7l1%203%201%201h-6l1-1%201-1v-1l1-1-1-1h-1l-5-1-6-2c-2-2-15-4-14-2l-1%202c-1%201-1%201%201%201%203%200%204%200%203%201h-2l-2%201-3%201c-3-1-4%200-1%202l6%201h4l2%201c3%200%209%204%207%205-1%201-1%201%201%201h1l1%202%204%203%203%203c-2%200-5-2-6-4h-3l-2%201c1%202-3%202-7%201-5-2-9-2-7%200l-1%201-2-1-1-1c-1%201-3%200-4-1-3-2-5-2-9-2l-6-1c-1-1-1-1-1%201l1%202c1%201%200%201-1%201l-4-2-3-2c-3%200-3%200-2%201l3%202h1l1%204c1%201%200%201-1%201s-2%200-1%201l-1%201c-2%200-2-2-1-3v-1l-3-2-1-3-1-2h1l1-1c0-1-1-2-3-1h-2l-1-1%202-1%201-2c1-1%200-1-2-1-3%200-11-1-10-2h-4c-5%200-7%200-10-2-4-2-11-2-13-1h-1l-3-2-4-2c0-1-14-3-15-2h1c8%202%2016%206%2016%207l2%201%202%201h-4a280%20280%200%2000-47%202l-1%201%202%202c6-1%2010%200%209%201l-13%201c0-2-4-1-5%201l1%201c2%200%202%200%201%203v2l1%201-1%201h-2v2h-3c-5%200-5%200-5%202l-1%202c-3%200-7%202-6%203h2c1%200%202%200%202%202l-2%202-1-1v-1c-2%200-2%209-2%2087v87h401l-1-102a28036%2028036%200%2000-2-135v-1c1-1%202-3%202-13%200-13%200-13-2-9m-81%2037l-2%203-1%204c0%202-1%202-2%202l-3%202c-1%202-2%203-5%202-4%200-4%200-3%202%202%202%202%202%200%202-3%201-4%203-2%203l2-1%203-1c2%200%203%201%203%202l1%201c2%200%201-3-1-4l-2-1c0-2%203-1%204%201%202%202%203%201%202-1l2-4c3-2%203-3%202-6%200-2%200-2%201-1%201%202%201%202%203%200l2-3-1-2h-3m-215%201l2%202c5%200%203%203-3%204-3%200-4%200-2-1%201-1%201-1-1-1H86c-2-1-2-1-3%201%200%202%202%204%205%204%202%200%202%201%200%201-2%201-6%204-4%204a196%20196%200%200017%202c6%201%208%200%2012-1%204-2%2011-1%2014%200%203%203%209%202%2012-1l5-3%201-1h5l4-1h5l1-1h3a185%20185%200%2000-26-6c-5%201-2%203%203%203s6%201%205%203h-1l-7-1c-6-1-6-1-5%201s2%202%204%202l1%201-2%201h-3l-1-3-1-2-1-1c-2%200-3%206-1%206v1c-2%200-4-6-2-7l-6-4-8-2-8-1-2%201M9%2056c1%201-2%203-4%203H3l2%202%201%201-2%202-1%201-2%202c0%201%205%202%208%200h3c1%202%202%200%201-2%200-2%200-2%202-2v-1h-2l-1-1c0-1%201-2%202-1v-2l-4-3-1%201m168%2020l1%201v1c-1%201%200%201%202%202l8%203c4%202%205%202%205-2l1-2h8l4%201c2-1-3-3-9-4l-6-1c-3%200-3%200-2%201%200%202-3%203-5%201-1-2-7-2-7-1m-71%208l-2%201-2%201-2%201-2%201c-1-1-1-1%201-2%201-1%201-1-1-2-4%200-9%202-7%203v1c-2%200-2%200-2%203a462%20462%200%20018%201l1-2v2l1%201%201%202v2c1%201%201%200%202-2%200-3%200-3%202-2%200%202%202%202%203%201l3%201c0%202%203%201%204-3%201-2%202-4%201-5s0-1%202-1c3%200%204%200%203-1h-4l-6-1h-4m59%205c-5%205-6%208-4%208l2%202c1%202%207%208%207%206h2l1-1-1-2h-3v-3l-1-1c-2-2-1-3%201-3s2%201%202%202c-1%203%202%204%203%202s1-3-2-4-2-2%203-3c2%200%203%200%202%201-1%200-1%201%201%203l2%201-1-1-1-2%202%201c3%203%204%203%203%200v-2l-1-1c-2-3%201-3%204%200%205%203%202-2-4-7-3-2-3-2-3%200v4l1%201-3-2-6-5-6%206M0%20184v84l1-80a1022%201022%200%2001-1-4m247%208l1%202h-3l-1-2-1%201c0%202-10%201-11%200s-1-1-1%201l-1%202v3c0%202%202%203%206%205s8%206%204%205c-1-1-3%200-3%201-2%201-2%201-2-1l1-1%201-1c-1-2-5-3-5-1h-1l-1%201v1l-1%202-1%204h4c2%200%202%200%200%201-1%201-1%201%202%202%202%201%203%201%202%203-1%201-1%201%201%201v1c-2%201-1%202%203%203l2%202%201%202-4%203-3%201%201%202%201%204c3%202%203%202%205%201l2-1c2%203%203%205%202%206-2%200-2%202-1%202l3-2%201-3v-2l1-3%201-4c1%200%203%203%203%205s1%202%203%202l2%201%203%201%202-1-1-1c-1%200-3-5-1-6%202-2%202-9%200-9s-2-5%200-5v-1c-2%200-3-3-1-4l1-3%201-3v-1l-2%201h-2v-4l-1-1-2-2%202-1c2%200%202%200%201-1h-3v-4l-1%201-2%201%201-2c1-1%201-1-1-2-2-2-3-2-3-1h-1v-1c1-1%201-1-1-1-3%200-3%200-2%201&#x27;%20fill=&#x27;%23d3d3d3&#x27;%20fill-rule=&#x27;evenodd&#x27;/%3e%3c/svg%3e" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source type='image/webp' srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/fecb9/hero.webp 114w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/0b20c/hero.webp 229w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/1cebc/hero.webp 457w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/c1755/hero.webp 686w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/1d656/hero.webp 914w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/efacd/hero.webp 2048w" sizes="(max-width: 457px) 100vw, 457px" /><source srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/70766/hero.jpg 114w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/2d2ef/hero.jpg 229w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/2bc81/hero.jpg 457w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/3fb07/hero.jpg 686w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/57263/hero.jpg 914w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/36dc8/hero.jpg 2048w" sizes="(max-width: 457px) 100vw, 457px" /><img loading="lazy" sizes="(max-width: 457px) 100vw, 457px" srcset="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/70766/hero.jpg 114w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/2d2ef/hero.jpg 229w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/2bc81/hero.jpg 457w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/3fb07/hero.jpg 686w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/57263/hero.jpg 914w,
https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/36dc8/hero.jpg 2048w" src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/static/c7b5f0892acafe11beef7096828afec1/2bc81/hero.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div><style data-emotion-css="12zduit">.css-12zduit{font-size:24px;line-height:1.45;word-break:keep-all;font-weight:bold;color:var(--theme-ui-colors-primary,#000);font-family:Georgia,"Noto Serif CJK SC","Source Han Serif SC","Source Han Serif CN","Songti SC","SimSun","STSong","AR PL Sungti",serif;font-size:22px;line-height:1.4;margin-bottom:45px;color:var(--theme-ui-colors-primary,#000);font-family:Georgia,"Noto Serif CJK SC","Source Han Serif SC","Source Han Serif CN","Songti SC","SimSun","STSong","AR PL Sungti",serif;-webkit-transition:color 0.3s ease-in-out;transition:color 0.3s ease-in-out;text-overflow:ellipsis;overflow-wrap:normal;-webkit-line-clamp:2;-webkit-box-orient:vertical;display:-webkit-box;white-space:normal;overflow:hidden;}@media (max-width:45.9375em){.css-12zduit{font-size:22px;}}@media (max-width:33.75em){.css-12zduit{font-size:20px;}}@media (max-width:33.75em){.css-12zduit{-webkit-line-clamp:3;}}@media (max-width:45.9375em){.css-12zduit{margin-bottom:15px;}}@media (max-width:33.75em){.css-12zduit{padding:30px 20px 0;margin-bottom:10px;-webkit-line-clamp:3;}}</style><h3 class="css-12zduit efc6uiy3">ESLint 检查 TypeScript 时报 “Unable to resolve path to module ‘xxx’” 错误</h3><style data-emotion-css="l4ss9o">.css-l4ss9o{text-overflow:ellipsis;overflow-wrap:normal;-webkit-line-clamp:2;-webkit-box-orient:vertical;display:-webkit-box;white-space:normal;overflow:hidden;font-size:16px;margin-bottom:10px;color:var(--theme-ui-colors-grey,#73737D);display:none;max-width:515px;}@media (max-width:33.75em){.css-l4ss9o{-webkit-line-clamp:3;}}@media (max-width:66.875em){.css-l4ss9o{display:-webkit-box;}}@media (max-width:45.9375em){.css-l4ss9o{margin-bottom:15px;}}@media (max-width:33.75em){.css-l4ss9o{max-width:100%;padding:0 20px;margin-bottom:20px;-webkit-line-clamp:3;}}</style><p class="css-l4ss9o efc6uiy4">解决 ESLint import 插件找不到模块路径问题</p><div class="css-118hiy6 efc6uiy5">2019-10-29</div></div></a></div><style data-emotion-css="1xyudza">.css-1xyudza{margin-bottom:65px;}</style><div class="css-1xyudza ea3ehcj5"></div></section></main><style data-emotion-css="1hk9het">.css-1hk9het{position:absolute;bottom:0;left:0;width:100%;height:590px;z-index:0;pointer-events:none;background:var(--theme-ui-colors-gradient,linear-gradient(180deg,rgba(217,219,224,0) 0%,#D9DBE0 100%));-webkit-transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);transition:background 0.25s var(--ease-in-out-quad),color 0.25s var(--ease-in-out-quad);}</style><div class="css-1hk9het ev1kwsw3"></div><style data-emotion-css="4j05o4">.css-4j05o4{width:100%;max-width:1220px;margin:0 auto;padding:0 4rem;}@media (max-width:66.875em){.css-4j05o4{max-width:850px;}}@media (max-width:45.9375em){.css-4j05o4{padding:0 2rem;max-width:527px;}}@media (max-width:33.75em){.css-4j05o4{max-width:100%;}}</style><section class="css-4j05o4 evd0b9i0"><style data-emotion-css="1nedy0r">.css-1nedy0r{position:relative;margin:140px auto 50px;border-bottom:1px solid var(--theme-ui-colors-horizontalRule,rgba(8,8,11,0.15));}@media (max-width:45.9375em){.css-1nedy0r{margin:60px auto;}}@media (max-width:33.75em){.css-1nedy0r{display:none;}}</style><div class="css-1nedy0r ev1kwsw1"></div><style data-emotion-css="1d54ci6">.css-1d54ci6{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;padding-bottom:80px;color:var(--theme-ui-colors-grey,#73737D);}@media (max-width:45.9375em){.css-1d54ci6{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;padding-bottom:100px;}}@media (max-width:33.75em){.css-1d54ci6{padding-bottom:50px;}}</style><div class="css-1d54ci6 ev1kwsw0"><style data-emotion-css="1pt7hv6">@media (max-width:45.9375em){.css-1pt7hv6{margin-bottom:80px;}}@media (max-width:33.75em){.css-1pt7hv6{margin:120px auto 100px;}}</style><div class="css-1pt7hv6 ev1kwsw2">© <!-- -->2019 – 2020<!-- --> <!-- -->devrsi0n</div><div><style data-emotion-css="10tgu6b">.css-10tgu6b{position:relative;margin-left:3.2rem;-webkit-text-decoration:none;text-decoration:none;max-width:16px;}.css-10tgu6b:hover svg:hover *{fill:var(--theme-ui-colors-primary,#000);}.css-10tgu6b:hover svg *{-webkit-transition:fill 0.25s var(--ease-in-out-quad);transition:fill 0.25s var(--ease-in-out-quad);}.css-10tgu6b:first-of-type{margin-left:0;}.css-10tgu6b:last-child{margin-right:0;}.css-10tgu6b[data-a11y='true']:focus::after{content:'';position:absolute;left:-50%;top:-20%;width:200%;height:160%;border:2px solid var(--theme-ui-colors-accent,#6166DC);background:rgba(255,255,255,0.01);border-radius:5px;}@media (max-width:45.9375em){.css-10tgu6b{margin:0 2.2rem;}}</style><a target="_blank" rel="noopener nofollow" data-a11y="false" aria-label="Link to https://bit.ly/2NcAZQZ" href="https://bit.ly/2NcAZQZ" class="css-10tgu6b e19hrbcy0"><svg width="16" height="13" viewBox="0 0 16 13" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.0658 2.34438C14.7013 1.96349 15.1892 1.3604 15.419 0.641811C14.8244 0.994439 14.1658 1.25056 13.4648 1.3886C12.9034 0.7905 12.1036 0.416748 11.2185 0.416748C9.51888 0.416748 8.14096 1.79461 8.14096 3.49411C8.14096 3.7353 8.16822 3.97019 8.22068 4.19542C5.66301 4.06708 3.39543 2.84191 1.8776 0.980064C1.6127 1.43458 1.46094 1.96322 1.46094 2.52719C1.46094 3.59485 2.00428 4.5368 2.83003 5.08865C2.32553 5.07268 1.85104 4.93425 1.43608 4.70376C1.43586 4.71659 1.43586 4.72949 1.43586 4.74244C1.43586 6.23349 2.49666 7.47732 3.90448 7.75999C3.64622 7.83033 3.37436 7.86792 3.09366 7.86792C2.89537 7.86792 2.70257 7.84866 2.51471 7.81272C2.90629 9.03537 4.0428 9.92509 5.38945 9.94994C4.33623 10.7753 3.00928 11.2673 1.56749 11.2673C1.31911 11.2673 1.07413 11.2528 0.833374 11.2243C2.19527 12.0975 3.81291 12.6069 5.55081 12.6069C11.2113 12.6069 14.3067 7.91763 14.3067 3.85096C14.3067 3.71753 14.3037 3.5848 14.2978 3.45285C14.899 3.01896 15.4208 2.47694 15.8334 1.8598C15.2815 2.10456 14.6884 2.26998 14.0658 2.34438Z" fill="#73737D"></path></svg><style data-emotion-css="mglztx">.css-mglztx{width:0px;height:0px;visibility:hidden;opacity:0;overflow:hidden;display:inline-block;}</style><span class="css-mglztx e19hrbcy1">Link to $<!-- -->https://bit.ly/2NcAZQZ</span></a><a target="_blank" rel="noopener nofollow" data-a11y="false" aria-label="Link to https://github.com/devrsi0n" href="https://github.com/devrsi0n" class="css-10tgu6b e19hrbcy0"><svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 0C3.1325 0 0 3.21173 0 7.17706C0 10.3529 2.00375 13.0353 4.78625 13.9863C5.13625 14.0491 5.2675 13.8338 5.2675 13.6454C5.2675 13.4749 5.25875 12.9097 5.25875 12.3087C3.5 12.6406 3.045 11.8691 2.905 11.4653C2.82625 11.259 2.485 10.622 2.1875 10.4516C1.9425 10.317 1.5925 9.98508 2.17875 9.97611C2.73 9.96714 3.12375 10.4964 3.255 10.7118C3.885 11.7973 4.89125 11.4923 5.29375 11.3039C5.355 10.8374 5.53875 10.5234 5.74 10.3439C4.1825 10.1645 2.555 9.54549 2.555 6.80026C2.555 6.01976 2.82625 5.37382 3.2725 4.87143C3.2025 4.692 2.9575 3.95635 3.3425 2.96951C3.3425 2.96951 3.92875 2.78111 5.2675 3.70516C5.8275 3.54367 6.4225 3.46293 7.0175 3.46293C7.6125 3.46293 8.2075 3.54367 8.7675 3.70516C10.1063 2.77214 10.6925 2.96951 10.6925 2.96951C11.0775 3.95635 10.8325 4.692 10.7625 4.87143C11.2087 5.37382 11.48 6.01079 11.48 6.80026C11.48 9.55446 9.84375 10.1645 8.28625 10.3439C8.54 10.5682 8.75875 10.9988 8.75875 11.6717C8.75875 12.6316 8.75 13.4032 8.75 13.6454C8.75 13.8338 8.88125 14.0581 9.23125 13.9863C11.9963 13.0353 14 10.3439 14 7.17706C14 3.21173 10.8675 0 7 0Z" fill="#73737D"></path></svg><span class="css-mglztx e19hrbcy1">Link to $<!-- -->https://github.com/devrsi0n</span></a><a target="_blank" rel="noopener nofollow" data-a11y="false" aria-label="Link to https://weibo.com/qianmofeiyu" href="https://weibo.com/qianmofeiyu" class="css-10tgu6b e19hrbcy0"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="#000000"><g><path fill="#73737D" d="M 16.28125 3.8125 C 16.054688 3.828125 15.816406 3.859375 15.59375 3.90625 C 15.179688 3.996094 14.910156 4.402344 15 4.8125 C 15.085938 5.226563 15.492188 5.496094 15.90625 5.40625 C 17.179688 5.136719 18.566406 5.53125 19.5 6.5625 C 20.433594 7.597656 20.679688 9.011719 20.28125 10.25 C 20.152344 10.652344 20.378906 11.089844 20.78125 11.21875 C 21.183594 11.347656 21.617188 11.121094 21.75 10.71875 C 22.3125 8.976563 21.96875 7.015625 20.65625 5.5625 C 19.671875 4.46875 18.296875 3.875 16.9375 3.8125 C 16.710938 3.800781 16.507813 3.796875 16.28125 3.8125 Z M 10.0625 6.09375 C 8.667969 6.242188 6.699219 7.332031 4.96875 9.0625 C 3.082031 10.949219 2 12.957031 2 14.6875 C 2 17.996094 6.226563 20 10.375 20 C 15.8125 20 19.4375 16.820313 19.4375 14.3125 C 19.4375 12.796875 18.179688 11.949219 17.03125 11.59375 C 16.75 11.507813 16.539063 11.464844 16.6875 11.09375 C 17.007813 10.289063 17.066406 9.589844 16.71875 9.09375 C 16.070313 8.164063 14.253906 8.210938 12.21875 9.0625 C 12.21875 9.0625 11.585938 9.351563 11.75 8.84375 C 12.0625 7.835938 12.019531 6.988281 11.53125 6.5 C 11.1875 6.152344 10.695313 6.027344 10.0625 6.09375 Z M 16.8125 6.5 C 16.589844 6.488281 16.375 6.515625 16.15625 6.5625 C 15.800781 6.636719 15.578125 7.019531 15.65625 7.375 C 15.734375 7.730469 16.082031 7.953125 16.4375 7.875 C 16.863281 7.785156 17.34375 7.902344 17.65625 8.25 C 17.96875 8.597656 18.042969 9.054688 17.90625 9.46875 C 17.792969 9.816406 17.964844 10.199219 18.3125 10.3125 C 18.660156 10.421875 19.046875 10.253906 19.15625 9.90625 C 19.429688 9.058594 19.265625 8.085938 18.625 7.375 C 18.144531 6.84375 17.476563 6.53125 16.8125 6.5 Z M 10.8125 10.90625 C 13.582031 11.003906 15.8125 12.378906 16 14.28125 C 16.214844 16.457031 13.71875 18.484375 10.40625 18.8125 C 7.09375 19.140625 4.214844 17.640625 4 15.46875 C 3.785156 13.292969 6.316406 11.265625 9.625 10.9375 C 10.039063 10.898438 10.417969 10.890625 10.8125 10.90625 Z M 8.9375 13 C 7.804688 13.101563 6.734375 13.75 6.25 14.6875 C 5.589844 15.964844 6.242188 17.378906 7.75 17.84375 C 9.308594 18.324219 11.140625 17.597656 11.78125 16.21875 C 12.410156 14.871094 11.605469 13.472656 10.0625 13.09375 C 9.691406 13 9.316406 12.964844 8.9375 13 Z M 8.21875 15.0625 C 8.351563 15.066406 8.472656 15.109375 8.59375 15.15625 C 9.082031 15.355469 9.234375 15.878906 8.9375 16.34375 C 8.632813 16.804688 7.988281 17.027344 7.5 16.8125 C 7.019531 16.601563 6.882813 16.074219 7.1875 15.625 C 7.414063 15.289063 7.824219 15.058594 8.21875 15.0625 Z "></path></g></svg><span class="css-mglztx e19hrbcy1">Link to $<!-- -->https://weibo.com/qianmofeiyu</span></a></div></div></section></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-108341680-2', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/create-react-from-scratch";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-9a96210c0e3b8bf502b6.js"],"component---src-templates-articles-template-tsx":["/component---src-templates-articles-template-tsx-53ac641c17fb6ddb0d20.js"],"component---src-templates-article-template-tsx":["/component---src-templates-article-template-tsx-15dc0f82dde1b20bc2e4.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-b998f1eb23cab9eae92d.js"]};/*]]>*/</script><script src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/component---src-templates-article-template-tsx-15dc0f82dde1b20bc2e4.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/commons-d79b95189de3e8e608cb.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/app-9a96210c0e3b8bf502b6.js" async=""></script><script src="https://cdn.jsdelivr.net/gh/devrsi0n/devrsi0n.github.io@0.5.2/webpack-runtime-e575948f7a0458f785af.js" async=""></script></body></html>